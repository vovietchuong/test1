<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Điểm danh Lớp học</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #1abc9c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --sidebar-width: 280px;
            --header-height: 70px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            display: flex;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .logo {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .logo h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .logo p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .nav-links {
            padding: 20px 0;
        }
        
        .nav-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .nav-item:hover, .nav-item.active {
            background-color: rgba(255,255,255,0.1);
            border-left-color: white;
        }
        
        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }
        
        .header {
            height: var(--header-height);
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            position: sticky;
            top: 0;
            z-index: 99;
        }
        
        .header-title h2 {
            font-size: 1.5rem;
            color: var(--dark-color);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .container {
            padding: 30px;
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .card-icon.primary {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }
        
        .card-icon.success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }
        
        .card-icon.warning {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }
        
        .card-icon.danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .card-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* Class Selector */
        .class-selector {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .class-selector select, .class-selector input, .class-selector button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: 16px;
        }
        
        .class-selector select {
            width: 100%;
            max-width: 300px;
        }
        
        .class-selector input {
            width: 150px;
        }
        
        /* Attendance Table */
        .attendance-table-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e9ecef;
        }
        
        .attendance-cell {
            text-align: center;
            cursor: pointer;
            min-width: 80px;
            transition: all 0.2s;
        }
        
        .attendance-cell.present {
            background-color: var(--success-color);
            color: white;
        }
        
        .attendance-cell.absent {
            background-color: var(--danger-color);
            color: white;
        }
        
        .attendance-cell:hover {
            transform: scale(1.05);
        }
        
        /* Actions */
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }
        
        .btn-info:hover {
            background-color: #16a085;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--danger-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        .session-management {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .student-actions {
            display: flex;
            gap: 5px;
        }
        
        .student-actions button {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background-color: var(--success-color);
        }
        
        .toast.error {
            background-color: var(--danger-color);
        }
        
        .toast.info {
            background-color: var(--info-color);
        }
        
        /* Report styles */
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .report-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .report-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .report-item .label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        /* Firebase Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #6c757d;
        }
        
        .sync-indicator.syncing {
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }
        
        .sync-indicator.synced {
            background-color: var(--success-color);
        }
        
        .sync-indicator.error {
            background-color: var(--danger-color);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
                overflow: visible;
            }
            
            .logo h1, .logo p, .nav-item span {
                display: none;
            }
            
            .nav-item {
                justify-content: center;
                padding: 15px;
            }
            
            .nav-item i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            
            .main-content {
                margin-left: 80px;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 0 15px;
            }
            
            .container {
                padding: 15px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .class-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .class-selector select, .class-selector input {
                max-width: 100%;
            }
            
            th, td {
                padding: 10px;
                font-size: 14px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Print Styles */
        @media print {
            .sidebar, .header, .actions, .class-selector {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .attendance-table-container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h1><i class="fas fa-graduation-cap"></i> HỆ THỐNG</h1>
            <p>Quản lý điểm danh</p>
        </div>
        <div class="nav-links">
            <div class="nav-item active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-tab="attendance">
                <i class="fas fa-clipboard-check"></i>
                <span>Điểm danh</span>
            </div>
            <div class="nav-item" data-tab="students">
                <i class="fas fa-users"></i>
                <span>Quản lý học sinh</span>
            </div>
            <div class="nav-item" data-tab="sessions">
                <i class="fas fa-calendar-alt"></i>
                <span>Quản lý buổi học</span>
            </div>
            <div class="nav-item" data-tab="reports">
                <i class="fas fa-chart-bar"></i>
                <span>Báo cáo</span>
            </div>
            <div class="nav-item" data-tab="settings">
                <i class="fas fa-cog"></i>
                <span>Cài đặt</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h2 id="pageTitle">Dashboard</h2>
            </div>
            <div class="header-actions">
                <button class="btn-primary" id="printBtn">
                    <i class="fas fa-print"></i> In
                </button>
                <div class="user-info">
                    <div class="user-avatar">GV</div>
                    <span>Giáo viên</span>
                </div>
            </div>
        </div>

        <!-- Container -->
        <div class="container">
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <div class="dashboard-cards">
                    <div class="card fade-in">
                        <div class="card-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-value" id="totalStudentsCard">0</div>
                        <div class="card-label">Tổng số học sinh</div>
                    </div>
                    <div class="card fade-in">
                        <div class="card-icon success">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="card-value" id="presentRateCard">0%</div>
                        <div class="card-label">Tỷ lệ có mặt</div>
                    </div>
                    <div class="card fade-in">
                        <div class="card-icon warning">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="card-value" id="totalClassesCard">9</div>
                        <div class="card-label">Lớp học</div>
                    </div>
                    <div class="card fade-in">
                        <div class="card-icon danger">
                            <i class="fas fa-user-times"></i>
                        </div>
                        <div class="card-value" id="absentRateCard">0%</div>
                        <div class="card-label">Tỷ lệ vắng mặt</div>
                    </div>
                </div>

                <div class="class-selector">
                    <select id="classSelect">
                        <option value="lop6">Lớp 6</option>
                        <option value="lop7">Lớp 7</option>
                        <option value="lop8">Lớp 8</option>
                        <option value="lop91">Lớp 9.1</option>
                        <option value="lop93">Lớp 9.3</option>
                        <option value="lop10">Lớp 10</option>
                        <option value="lop121">Lớp 12.1</option>
                        <option value="lop122">Lớp 12.2</option>
                        <option value="lop123">Lớp 12.3</option>
                    </select>
                    <button class="btn-primary" id="goToAttendanceBtn">
                        <i class="fas fa-clipboard-check"></i> Điểm danh ngay
                    </button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Thống kê điểm danh gần đây</h3>
                    <div id="recentStats">
                        <!-- Thống kê sẽ được thêm bằng JavaScript -->
                    </div>
                    <div class="sync-status">
                        <div class="sync-indicator" id="syncIndicator"></div>
                        <span id="syncStatusText">Đang kết nối...</span>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div class="tab-content" id="attendance">
                <div class="class-selector">
                    <select id="attendanceClassSelect">
                        <option value="lop6">Lớp 6</option>
                        <option value="lop7">Lớp 7</option>
                        <option value="lop8">Lớp 8</option>
                        <option value="lop91">Lớp 9.1</option>
                        <option value="lop93">Lớp 9.3</option>
                        <option value="lop10">Lớp 10</option>
                        <option value="lop121">Lớp 12.1</option>
                        <option value="lop122">Lớp 12.2</option>
                        <option value="lop123">Lớp 12.3</option>
                    </select>
                    <input type="date" id="sessionDate">
                    <button class="btn-primary" id="addSessionBtn">
                        <i class="fas fa-plus"></i> Thêm buổi học
                    </button>
                </div>

                <div class="actions">
                    <button class="btn-primary" id="saveBtn">
                        <i class="fas fa-save"></i> Lưu điểm danh
                    </button>
                    <button class="btn-success" id="markAllPresent">
                        <i class="fas fa-check-circle"></i> Điểm danh tất cả
                    </button>
                    <button class="btn-danger" id="markAllAbsent">
                        <i class="fas fa-times-circle"></i> Vắng tất cả
                    </button>
                    <button class="btn-info" id="exportBtn">
                        <i class="fas fa-file-export"></i> Xuất dữ liệu
                    </button>
                </div>

                <div class="attendance-table-container">
                    <table id="attendanceTable">
                        <thead id="attendanceHeader">
                            <tr>
                                <th>STT</th>
                                <th>Họ và tên</th>
                                <th>SĐT PH</th>
                                <!-- Các buổi học sẽ được thêm bằng JavaScript -->
                            </tr>
                        </thead>
                        <tbody id="attendanceBody">
                            <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Students Tab -->
            <div class="tab-content" id="students">
                <div class="class-selector">
                    <select id="studentClassSelect">
                        <option value="lop6">Lớp 6</option>
                        <option value="lop7">Lớp 7</option>
                        <option value="lop8">Lớp 8</option>
                        <option value="lop91">Lớp 9.1</option>
                        <option value="lop93">Lớp 9.3</option>
                        <option value="lop10">Lớp 10</option>
                        <option value="lop121">Lớp 12.1</option>
                        <option value="lop122">Lớp 12.2</option>
                        <option value="lop123">Lớp 12.3</option>
                    </select>
                    <button class="btn-success" id="addStudentBtn">
                        <i class="fas fa-user-plus"></i> Thêm học sinh
                    </button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Danh sách học sinh</h3>
                    <div id="studentListContainer">
                        <!-- Danh sách học sinh sẽ được thêm bằng JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div class="tab-content" id="sessions">
                <div class="class-selector">
                    <select id="sessionClassSelect">
                        <option value="lop6">Lớp 6</option>
                        <option value="lop7">Lớp 7</option>
                        <option value="lop8">Lớp 8</option>
                        <option value="lop91">Lớp 9.1</option>
                        <option value="lop93">Lớp 9.3</option>
                        <option value="lop10">Lớp 10</option>
                        <option value="lop121">Lớp 12.1</option>
                        <option value="lop122">Lớp 12.2</option>
                        <option value="lop123">Lớp 12.3</option>
                    </select>
                    <button class="btn-success" id="addNewSessionBtn">
                        <i class="fas fa-plus"></i> Thêm buổi học
                    </button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Quản lý buổi học</h3>
                    <div id="sessionListContainer">
                        <!-- Danh sách buổi học sẽ được thêm bằng JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-content" id="reports">
                <div class="class-selector">
                    <select id="reportClassSelect">
                        <option value="lop6">Lớp 6</option>
                        <option value="lop7">Lớp 7</option>
                        <option value="lop8">Lớp 8</option>
                        <option value="lop91">Lớp 9.1</option>
                        <option value="lop93">Lớp 9.3</option>
                        <option value="lop10">Lớp 10</option>
                        <option value="lop121">Lớp 12.1</option>
                        <option value="lop122">Lớp 12.2</option>
                        <option value="lop123">Lớp 12.3</option>
                    </select>
                    <button class="btn-primary" id="generateReportBtn">
                        <i class="fas fa-chart-pie"></i> Tạo báo cáo
                    </button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Báo cáo điểm danh</h3>
                    <div id="reportContainer">
                        <!-- Báo cáo sẽ được thêm bằng JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Cài đặt hệ thống</h3>
                    <div class="form-group">
                        <label for="schoolName">Tên trung tâm:</label>
                        <input type="text" id="schoolName" value="HỌC THÊM - LUYỆN THI KIÊN NĂNG">
                    </div>
                    <div class="form-group">
                        <label for="schoolAddress">Địa chỉ:</label>
                        <input type="text" id="schoolAddress" value="Số 07, Ngõ 730 đường Lê Thái Tổ, P Kỳ Long, TX Kỳ Anh, T Hà Tĩnh">
                    </div>
                    <div class="form-group">
                        <label for="schoolMotto">Khẩu hiệu:</label>
                        <input type="text" id="schoolMotto" value="Kiên trì học tập - Tài năng toả sáng">
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" id="saveSettingsBtn">
                            <i class="fas fa-save"></i> Lưu cài đặt
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Quản lý dữ liệu</h3>
                    <div class="actions">
                        <button class="btn-warning" id="backupDataBtn">
                            <i class="fas fa-download"></i> Sao lưu dữ liệu
                        </button>
                        <button class="btn-danger" id="resetDataBtn">
                            <i class="fas fa-trash"></i> Đặt lại dữ liệu
                        </button>
                        <button class="btn-info" id="syncDataBtn">
                            <i class="fas fa-sync-alt"></i> Đồng bộ dữ liệu
                        </button>
                    </div>
                    <div class="sync-status">
                        <div class="sync-indicator" id="syncIndicatorSettings"></div>
                        <span id="syncStatusTextSettings">Đang kết nối...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Quản lý học sinh -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Quản lý học sinh</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="studentName">Họ và tên:</label>
                    <input type="text" id="studentName" placeholder="Nhập họ và tên">
                </div>
                <div class="form-group">
                    <label for="studentPhone">Số điện thoại phụ huynh:</label>
                    <input type="text" id="studentPhone" placeholder="Nhập số điện thoại">
                </div>
                <div class="form-actions">
                    <button class="btn-danger" id="cancelStudentBtn">Hủy</button>
                    <button class="btn-success" id="saveStudentBtn">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Quản lý buổi học -->
    <div id="sessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Quản lý buổi học</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sessionName">Tên buổi học:</label>
                    <input type="text" id="sessionName" placeholder="VD: B1, B2, ...">
                </div>
                <div class="form-group">
                    <label for="sessionDateModal">Ngày học:</label>
                    <input type="date" id="sessionDateModal">
                </div>
                <div class="form-actions">
                    <button class="btn-danger" id="cancelSessionBtn">Hủy</button>
                    <button class="btn-success" id="saveSessionBtn">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toastContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAPcaScN-HrCcxiUz_J1QrrREF9sxCfvD8",
            authDomain: "mathhubvn.firebaseapp.com",
            projectId: "mathhubvn",
            storageBucket: "mathhubvn.firebasestorage.app",
            messagingSenderId: "1001364433767",
            appId: "1:1001364433767:web:ae1547dc7d1524a6319dc2",
            measurementId: "G-2YNQZ48JVK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Dữ liệu lớp học đầy đủ
        const classData = {
            lop6: [
                { stt: 1, name: "Nguyễn Khánh Linh", phone: "0985826017" },
                { stt: 2, name: "Phan Nguyễn Tuệ Nhi", phone: "0984070626" },
                { stt: 3, name: "Mai Anh Hào", phone: "0392292354" },
                { stt: 4, name: "Lê Hồng Ngọc", phone: "0986986498" },
                { stt: 5, name: "Trần Bảo Long", phone: "0862996456" },
                { stt: 6, name: "Nguyễn Phan Tuấn Nhật", phone: "0966200114" },
                { stt: 7, name: "Lê Uy Vũ", phone: "0974491401" },
                { stt: 8, name: "Lê Thị Huyền Trang", phone: "0353586606" },
                { stt: 9, name: "Phạm Tiến Dũng", phone: "0973564821" },
                { stt: 10, name: "Nguyễn Văn Đức", phone: "343661491" },
                { stt: 11, name: "Lê Thành Huân", phone: "865274123" },
                { stt: 12, name: "An Đông", phone: "916223566" },
                { stt: 13, name: "Hải Đăng", phone: "964206308" },
                { stt: 14, name: "Quỳnh Chi", phone: "976981688" }
            ],
            lop7: [
                { stt: 1, name: "Bùi Hải Đăng", phone: "0976783260" },
                { stt: 2, name: "Võ Lê Anh Thư", phone: "0392441116" },
                { stt: 3, name: "Nguyễn Bảo Châu", phone: "0966739805" },
                { stt: 4, name: "Đinh Hữu Dũng", phone: "0367689293" },
                { stt: 5, name: "Trịnh Vương Nguyên Khang", phone: "0776216918" },
                { stt: 6, name: "Từ Quang Thuận", phone: "0327933871" },
                { stt: 7, name: "Nguyễn Thị Hoài Thương", phone: "372426797" },
                { stt: 8, name: "Nguyễn Trần Gia Như", phone: "911637557" },
                { stt: 9, name: "Nguyễn Thiện Gia Linh", phone: "369602903" },
                { stt: 10, name: "Nguyễn Tuấn Vỹ", phone: "399766786" }
            ],
            lop8: [
                { stt: 1, name: "An Vinh", phone: "" },
                { stt: 2, name: "Vương Đình Quang", phone: "0333052700" },
                { stt: 3, name: "Lê Đăng Tuấn", phone: "0982043856" },
                { stt: 4, name: "Lê Trần Bảo Chi", phone: "0967559997" },
                { stt: 5, name: "Lê Nguyễn Bảo Trân", phone: "09323612" },
                { stt: 6, name: "Nguyễn Quốc Cường", phone: "0833599086" },
                { stt: 7, name: "Lê Phan Anh Quân", phone: "" },
                { stt: 8, name: "Khánh Hiền", phone: "0985951002" },
                { stt: 9, name: "Nguyễn Thị Ngân Thương", phone: "0368325450" },
                { stt: 10, name: "Tiến Khang", phone: "968984564" }
            ],
            lop91: [
                { stt: 1, name: "Nguyễn Tiến Dũng", phone: "0934423378" },
                { stt: 2, name: "Trần Công Dũng", phone: "0982827596" },
                { stt: 3, name: "Lê Quỳnh Trâm", phone: "0974167727" },
                { stt: 4, name: "Nguyễn Hà An", phone: "0981317386" },
                { stt: 5, name: "Nguyễn Thế Thành Nhân", phone: "0982954134" },
                { stt: 6, name: "Lê Tuấn Sang", phone: "0965616446" },
                { stt: 7, name: "Nguyễn Thái Hoà", phone: "0987879498" },
                { stt: 8, name: "Nguyễn Huy Khang", phone: "0968932659" },
                { stt: 9, name: "Hà Lê Bảo Ngọc", phone: "0338860869" },
                { stt: 10, name: "Lê Hoàng Nhi", phone: "0966336854" },
                { stt: 11, name: "Tưởng Nguyễn Tuấn Hưng", phone: "0967360169" },
                { stt: 12, name: "Trần Công Tuấn", phone: "0384233638" },
                { stt: 13, name: "Phạm Gia Tuấn", phone: "0363280935" },
                { stt: 14, name: "Lê Phi Bảo An", phone: "0899642032" },
                { stt: 15, name: "Lê Hồng Phúc", phone: "0838983715" },
                { stt: 16, name: "Võ Thái Nhật", phone: "0397669687" },
                { stt: 17, name: "Võ Văn Nam", phone: "" },
                { stt: 18, name: "Lê Thủy Tiên", phone: "" },
                { stt: 19, name: "Trần Khánh Linh", phone: "" }
            ],
            lop93: [
                { stt: 1, name: "Lê Thị Hải Yến", phone: "" },
                { stt: 2, name: "Nguyễn Thị Minh Ngọc", phone: "" },
                { stt: 3, name: "Lê Thị Ngân", phone: "" },
                { stt: 4, name: "Lê Thị Trúc Linh", phone: "" },
                { stt: 5, name: "Nguyễn Thị Mai Linh", phone: "" },
                { stt: 6, name: "Hoàng Thị Tuyết Mai", phone: "" },
                { stt: 7, name: "Lê Thị Phương Linh", phone: "" },
                { stt: 8, name: "Lê Nguyễn Hải Yến", phone: "" },
                { stt: 9, name: "Nguyễn Thị Thanh Thảo", phone: "" },
                { stt: 10, name: "Lê Thị Lan", phone: "" },
                { stt: 11, name: "Nguyễn Thị Tuyết Nga", phone: "" },
                { stt: 12, name: "Nguyễn Thị Ánh", phone: "" },
                { stt: 13, name: "Nguyễn Kim Sang", phone: "" },
                { stt: 14, name: "Nguyễn Hải Quân", phone: "" },
                { stt: 15, name: "Lê Dương Hoài Phát", phone: "" },
                { stt: 16, name: "Nguyễn Bảo Thắng", phone: "" },
                { stt: 17, name: "Võ Văn Nam", phone: "" },
                { stt: 18, name: "Võ Thái Nhật", phone: "" },
                { stt: 19, name: "Thành Nhân", phone: "" },
                { stt: 20, name: "Anh Nguyên", phone: "" },
                { stt: 21, name: "Lê Duy Mạnh", phone: "" },
                { stt: 22, name: "Nguyễn Văn Nhân Tâm", phone: "" },
                { stt: 23, name: "Hoàng Đức Ái", phone: "" },
                { stt: 24, name: "Nguyễn Trung Hiếu", phone: "" },
                { stt: 25, name: "Lê Thủy Tiên", phone: "" },
                { stt: 26, name: "Nguyễn Minh Tuyết", phone: "" }
            ],
            lop10: [
                { stt: 1, name: "Nguyễn Phúc Nguyên", phone: "0979828001" },
                { stt: 2, name: "Thanh Hồ", phone: "0869919456" },
                { stt: 3, name: "Lê Quỳnh Trang", phone: "0966013645" },
                { stt: 4, name: "Lê Châu Anh", phone: "0386304227" },
                { stt: 5, name: "Mai Phương", phone: "0979225231" },
                { stt: 6, name: "Trần Nguyễn Như Quỳnh", phone: "0327812182" },
                { stt: 7, name: "Phan Văn Đồng", phone: "0362622778" },
                { stt: 8, name: "Võ Văn Trung", phone: "0975855681" },
                { stt: 9, name: "Trần Nguyễn Ngọc Châm", phone: "0356987005" },
                { stt: 10, name: "Trịnh Thuỳ Linh", phone: "0963447416" },
                { stt: 11, name: "Trần Xuân Nhật", phone: "0399052897" },
                { stt: 12, name: "Trần Văn Ngọc My", phone: "0377178985" },
                { stt: 13, name: "Phạm Ngọc Tiền", phone: "0867110365" },
                { stt: 14, name: "Nguyễn Thị Bảo Yến", phone: "346274673" },
                { stt: 15, name: "Nguyễn Nam Phong", phone: "968451405" },
                { stt: 16, name: "Hoàng Thị Mận", phone: "326487864" },
                { stt: 17, name: "Nguyễn Quỳnh Anh", phone: "983873779" },
                { stt: 18, name: "Hoàng Hoa Đào", phone: "326487864" },
                { stt: 19, name: "Trần Ngọc Tài", phone: "984463859" }
            ],
            lop121: [
                { stt: 1, name: "Lê Thị Ngọc Ngà", phone: "0348302655" },
                { stt: 2, name: "Nguyễn Thị Ngọc Thư", phone: "0377250421" },
                { stt: 3, name: "Văn Thị Khánh Trúc", phone: "0978765170" },
                { stt: 4, name: "Nguyễn Thị Ngọc Bích", phone: "0358285239" },
                { stt: 5, name: "Nguyễn Thanh Hằng", phone: "0982125222" },
                { stt: 6, name: "Lê Thị Minh Nguyệt", phone: "0961363713" },
                { stt: 7, name: "Trần Thị Anh Thư", phone: "0384805389" },
                { stt: 8, name: "Trần Thị Dung", phone: "0976654272" },
                { stt: 9, name: "Lê Thị Hải Yến", phone: "0868474264" },
                { stt: 10, name: "Phạm Ngọc Thanh Phương", phone: "0965511354" },
                { stt: 11, name: "Lê Thị Hoài Mây", phone: "0896992337" },
                { stt: 12, name: "Chu Nguyễn Hà An", phone: "0961612351" },
                { stt: 13, name: "Nguyễn Bảo Tâm", phone: "0384787758" },
                { stt: 14, name: "Chu Trần Mai Linh", phone: "0981677615" },
                { stt: 15, name: "Lê Thị Ngọc Hà", phone: "0327243125" },
                { stt: 16, name: "Nguyễn Thị Mai Phương", phone: "0986540820" },
                { stt: 17, name: "Trần Thị Ánh Ngà", phone: "0965406504" },
                { stt: 18, name: "Nguyễn Thị Huyền Trang", phone: "0327054180" },
                { stt: 19, name: "Trịnh Thị Cầm Trang", phone: "974578908" },
                { stt: 20, name: "Lê Văn Minh", phone: "0396015597" },
                { stt: 21, name: "Trịnh Thị Lan Phương", phone: "" },
                { stt: 22, name: "Nguyễn Thái Tuấn", phone: "" },
                { stt: 23, name: "Chu Tuấn Sang", phone: "" },
                { stt: 24, name: "Phùng Hoàng Ngọc Anh", phone: "898606099" },
                { stt: 25, name: "Nguyễn Thị Thùy Linh", phone: "374419126" },
                { stt: 26, name: "Chu Thị Cẩm Giang", phone: "342768495" },
                { stt: 27, name: "Nguyễn Linh Đan", phone: "983039787" },
                { stt: 28, name: "Trần Thị Hà Giang", phone: "387984385" },
                { stt: 29, name: "Nguyễn Huyền Trang", phone: "394759697" }
            ],
            lop122: [
                { stt: 1, name: "Trần Thảo Nguyên", phone: "0367011437" },
                { stt: 2, name: "Cao Văn Trí", phone: "0853466659" },
                { stt: 3, name: "Nguyễn Đình Thái", phone: "0969582647" },
                { stt: 4, name: "Lê Văn Nam", phone: "0896224945" },
                { stt: 5, name: "Lê Thị Bé", phone: "0387367975" },
                { stt: 6, name: "Nguyễn Duy Minh", phone: "0362380513" },
                { stt: 7, name: "Đinh Nguyễn Thục Nhi", phone: "0944055746" },
                { stt: 8, name: "Nguyễn Thị Quỳnh Thơm", phone: "0763019054" },
                { stt: 9, name: "Nguyễn Bảo Long", phone: "0365493406" },
                { stt: 10, name: "Chu Thị Hiền", phone: "0362696563" },
                { stt: 11, name: "Võ Ngọc Bảo Uyên", phone: "0375740817" },
                { stt: 12, name: "Phạm Khánh Toán", phone: "0337341013" },
                { stt: 13, name: "Trần Vương Ngọc Hiếu", phone: "0356883119" },
                { stt: 14, name: "Võ Thị Thùy Linh", phone: "979517608" },
                { stt: 15, name: "Lê Thị Thùy Trang", phone: "336152750" },
                { stt: 16, name: "Khánh Huyền", phone: "337370885" },
                { stt: 17, name: "Nguyễn Phương Dung", phone: "" },
                { stt: 18, name: "Võ Văn Hoàng", phone: "" },
                { stt: 19, name: "Mai Thúy Hằng", phone: "" },
                { stt: 20, name: "Lê Thành Đạt", phone: "" },
                { stt: 21, name: "Phùng Thanh Phương", phone: "374089526" },
                { stt: 22, name: "Trần Việt Hùng", phone: "" },
                { stt: 23, name: "Nguyễn Thị Hà Linh", phone: "" },
                { stt: 24, name: "Trần Thị Mỹ Duyên", phone: "" }
            ],
            lop123: [
                { stt: 1, name: "Trần Hồng Thắm", phone: "0383662109" },
                { stt: 2, name: "Võ Thị Ngọc Thuỳ", phone: "0394108247" },
                { stt: 3, name: "Hồ Thị Kim Dung", phone: "0367520879" },
                { stt: 4, name: "Đậu Nhung", phone: "0763101598" },
                { stt: 5, name: "Trần Thị Thu Trang", phone: "0983700247" },
                { stt: 6, name: "Võ Thị Yến", phone: "0352593309" },
                { stt: 7, name: "Lê Thị Kiều Trang", phone: "0342768495" },
                { stt: 8, name: "Phạn Thị Hà Linh", phone: "0966024051" },
                { stt: 9, name: "Nguyễn Linh Đan", phone: "0983039787" },
                { stt: 10, name: "Lê Anh Ngọc", phone: "0979288254" },
                { stt: 11, name: "Lê Thanh Lý", phone: "0394260193" },
                { stt: 12, name: "Nguyễn Tiến Duy", phone: "975973525" },
                { stt: 13, name: "Lê Thị Thu Hiền", phone: "399239364" },
                { stt: 14, name: "Trịnh Thị Thanh Hiền", phone: "961791962" },
                { stt: 15, name: "Nguyễn Thị Hiền", phone: "357210180" },
                { stt: 16, name: "Trần Thị Hiệp", phone: "366850388" },
                { stt: 17, name: "Lê Dương Hải Cường", phone: "" },
                { stt: 18, name: "Trương Nữ Hoàng Dung", phone: "" },
                { stt: 19, name: "Nguyễn Thị Huyền Trang", phone: "" },
                { stt: 20, name: "Chu Văn Hòa", phone: "" },
                { stt: 21, name: "Nguyễn Thị Ánh Mỹ", phone: "0985826017" }
            ]
        };

        // Lưu trữ dữ liệu điểm danh và buổi học
        let attendanceData = {};
        let sessionData = {};
        let currentEditingStudent = null;
        let currentEditingSession = null;
        let currentClass = 'lop6';
        let isOnline = false;
        let syncInProgress = false;
        
        // Hiển thị thông báo
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            // Hiển thị toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Ẩn và xóa toast sau 3 giây
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // Cập nhật trạng thái kết nối
        function updateConnectionStatus(connected) {
            isOnline = connected;
            const indicator = document.getElementById('syncIndicator');
            const indicatorSettings = document.getElementById('syncIndicatorSettings');
            const statusText = document.getElementById('syncStatusText');
            const statusTextSettings = document.getElementById('syncStatusTextSettings');
            
            if (connected) {
                indicator.className = 'sync-indicator synced';
                indicatorSettings.className = 'sync-indicator synced';
                statusText.textContent = 'Đã kết nối Firebase';
                statusTextSettings.textContent = 'Đã kết nối Firebase';
            } else {
                indicator.className = 'sync-indicator error';
                indicatorSettings.className = 'sync-indicator error';
                statusText.textContent = 'Mất kết nối Firebase';
                statusTextSettings.textContent = 'Mất kết nối Firebase';
            }
        }
        
        // Đồng bộ dữ liệu lên Firebase
        async function syncToFirebase() {
            if (!isOnline) {
                showToast('Không thể đồng bộ: Mất kết nối Firebase', 'error');
                return;
            }
            
            if (syncInProgress) {
                showToast('Đang đồng bộ dữ liệu...', 'info');
                return;
            }
            
            syncInProgress = true;
            const indicator = document.getElementById('syncIndicator');
            const indicatorSettings = document.getElementById('syncIndicatorSettings');
            indicator.className = 'sync-indicator syncing';
            indicatorSettings.className = 'sync-indicator syncing';
            
            try {
                // Lưu dữ liệu lên Firebase
                await db.collection('system').doc('attendanceData').set({
                    data: attendanceData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('system').doc('sessionData').set({
                    data: sessionData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('system').doc('classData').set({
                    data: classData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Đã đồng bộ dữ liệu lên Firebase', 'success');
            } catch (error) {
                console.error('Lỗi đồng bộ Firebase:', error);
                showToast('Lỗi đồng bộ dữ liệu: ' + error.message, 'error');
            } finally {
                syncInProgress = false;
                indicator.className = 'sync-indicator synced';
                indicatorSettings.className = 'sync-indicator synced';
            }
        }
        
        // Tải dữ liệu từ Firebase
        async function loadFromFirebase() {
            if (!isOnline) {
                showToast('Không thể tải dữ liệu: Mất kết nối Firebase', 'error');
                return;
            }
            
            try {
                // Tải dữ liệu từ Firebase
                const attendanceDoc = await db.collection('system').doc('attendanceData').get();
                const sessionDoc = await db.collection('system').doc('sessionData').get();
                const classDoc = await db.collection('system').doc('classData').get();
                
                if (attendanceDoc.exists) {
                    attendanceData = attendanceDoc.data().data || {};
                }
                
                if (sessionDoc.exists) {
                    sessionData = sessionDoc.data().data || {};
                }
                
                if (classDoc.exists) {
                    // Cập nhật classData với dữ liệu từ Firebase
                    const firebaseClassData = classDoc.data().data || {};
                    Object.keys(firebaseClassData).forEach(classId => {
                        if (classData[classId]) {
                            classData[classId] = firebaseClassData[classId];
                        }
                    });
                }
                
                showToast('Đã tải dữ liệu từ Firebase', 'success');
                saveAllData();
                updateDashboard();
                displayClass(currentClass);
                displayStudentList(currentClass);
                displaySessionList(currentClass);
            } catch (error) {
                console.error('Lỗi tải dữ liệu Firebase:', error);
                showToast('Lỗi tải dữ liệu: ' + error.message, 'error');
            }
        }
        
        // Khởi tạo dữ liệu từ localStorage hoặc Firebase
        function initializeData() {
            const savedAttendanceData = localStorage.getItem('attendanceData');
            const savedSessionData = localStorage.getItem('sessionData');
            const savedClassData = localStorage.getItem('classData');
            
            if (savedAttendanceData) {
                attendanceData = JSON.parse(savedAttendanceData);
            }
            
            if (savedSessionData) {
                sessionData = JSON.parse(savedSessionData);
            }
            
            if (savedClassData) {
                // Cập nhật classData với dữ liệu từ localStorage
                const updatedClassData = JSON.parse(savedClassData);
                Object.keys(updatedClassData).forEach(classId => {
                    if (classData[classId]) {
                        classData[classId] = updatedClassData[classId];
                    }
                });
            }
            
            // Đảm bảo mỗi lớp có dữ liệu buổi học
            Object.keys(classData).forEach(classId => {
                if (!sessionData[classId]) {
                    sessionData[classId] = [
                        { id: 'B1', name: 'B1', date: '2025-09-10' },
                        { id: 'B2', name: 'B2', date: '' },
                        { id: 'B3', name: 'B3', date: '' },
                        { id: 'B4', name: 'B4', date: '' },
                        { id: 'B5', name: 'B5', date: '' },
                        { id: 'B6', name: 'B6', date: '' },
                        { id: 'B7', name: 'B7', date: '' },
                        { id: 'B8', name: 'B8', date: '' },
                        { id: 'B9', name: 'B9', date: '' },
                        { id: 'B10', name: 'B10', date: '' }
                    ];
                }
                
                // Đảm bảo mỗi học sinh có dữ liệu điểm danh
                if (!attendanceData[classId]) {
                    attendanceData[classId] = {};
                }
                
                classData[classId].forEach(student => {
                    if (!attendanceData[classId][student.stt]) {
                        attendanceData[classId][student.stt] = {};
                    }
                    
                    sessionData[classId].forEach(session => {
                        if (!attendanceData[classId][student.stt][session.id]) {
                            attendanceData[classId][student.stt][session.id] = true;
                        }
                    });
                });
            });
            
            saveAllData();
            updateDashboard();
        }
        
        // Lưu tất cả dữ liệu vào localStorage
        function saveAllData() {
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            localStorage.setItem('sessionData', JSON.stringify(sessionData));
            localStorage.setItem('classData', JSON.stringify(classData));
        }
        
        // Cập nhật Dashboard
        function updateDashboard() {
            const totalStudents = Object.values(classData).reduce((total, students) => total + students.length, 0);
            document.getElementById('totalStudentsCard').textContent = totalStudents;
            document.getElementById('totalClassesCard').textContent = Object.keys(classData).length;
            
            // Tính tỷ lệ điểm danh trung bình
            let totalPresent = 0;
            let totalSessions = 0;
            
            Object.keys(attendanceData).forEach(classId => {
                Object.keys(attendanceData[classId]).forEach(studentId => {
                    Object.values(attendanceData[classId][studentId]).forEach(isPresent => {
                        if (isPresent) totalPresent++;
                        totalSessions++;
                    });
                });
            });
            
            const presentRate = totalSessions > 0 ? Math.round((totalPresent / totalSessions) * 100) : 0;
            const absentRate = 100 - presentRate;
            
            document.getElementById('presentRateCard').textContent = `${presentRate}%`;
            document.getElementById('absentRateCard').textContent = `${absentRate}%`;
            
            // Hiển thị thống kê gần đây
            displayRecentStats();
        }
        
        // Hiển thị thống kê gần đây
        function displayRecentStats() {
            const recentStats = document.getElementById('recentStats');
            recentStats.innerHTML = '';
            
            Object.keys(classData).forEach(classId => {
                const classStats = document.createElement('div');
                classStats.style.padding = '10px';
                classStats.style.borderBottom = '1px solid #eee';
                
                const className = document.getElementById('classSelect').querySelector(`option[value="${classId}"]`).textContent;
                const studentCount = classData[classId].length;
                
                // Tính tỷ lệ điểm danh cho lớp này
                let classPresent = 0;
                let classSessions = 0;
                
                if (attendanceData[classId]) {
                    Object.keys(attendanceData[classId]).forEach(studentId => {
                        Object.values(attendanceData[classId][studentId]).forEach(isPresent => {
                            if (isPresent) classPresent++;
                            classSessions++;
                        });
                    });
                }
                
                const classPresentRate = classSessions > 0 ? Math.round((classPresent / classSessions) * 100) : 0;
                
                classStats.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>${className}</strong></span>
                        <span>${studentCount} học sinh</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span>Tỷ lệ có mặt:</span>
                        <span>${classPresentRate}%</span>
                    </div>
                `;
                
                recentStats.appendChild(classStats);
            });
        }
        
        // Hiển thị danh sách lớp học
        function displayClass(classId) {
            currentClass = classId;
            const tbody = document.getElementById('attendanceBody');
            const thead = document.getElementById('attendanceHeader');
            tbody.innerHTML = '';
            
            // Cập nhật tiêu đề bảng với các buổi học
            const headerRow = thead.querySelector('tr');
            // Xóa các cột buổi học cũ (giữ lại 3 cột đầu: STT, Họ và tên, SĐT PH)
            while (headerRow.children.length > 3) {
                headerRow.removeChild(headerRow.lastChild);
            }
            
            const sessions = sessionData[classId] || [];
            sessions.forEach(session => {
                const th = document.createElement('th');
                th.textContent = `${session.name}: ${session.date || 'Chưa có ngày'}`;
                headerRow.appendChild(th);
            });
            
            const students = classData[classId];
            
            students.forEach(student => {
                const row = document.createElement('tr');
                
                // STT
                const sttCell = document.createElement('td');
                sttCell.textContent = student.stt;
                row.appendChild(sttCell);
                
                // Họ và tên
                const nameCell = document.createElement('td');
                nameCell.textContent = student.name;
                row.appendChild(nameCell);
                
                // SĐT PH
                const phoneCell = document.createElement('td');
                phoneCell.textContent = student.phone;
                row.appendChild(phoneCell);
                
                // Tạo ô điểm danh cho các buổi học
                sessions.forEach(session => {
                    const sessionCell = document.createElement('td');
                    sessionCell.className = 'attendance-cell';
                    sessionCell.dataset.studentId = student.stt;
                    sessionCell.dataset.session = session.id;
                    
                    // Kiểm tra trạng thái điểm danh
                    const isPresent = attendanceData[classId] && 
                                      attendanceData[classId][student.stt] && 
                                      attendanceData[classId][student.stt][session.id];
                    
                    if (isPresent) {
                        sessionCell.textContent = '✓';
                        sessionCell.classList.add('present');
                    } else {
                        sessionCell.textContent = '✗';
                        sessionCell.classList.add('absent');
                    }
                    
                    // Thêm sự kiện click để thay đổi trạng thái
                    sessionCell.addEventListener('click', function() {
                        toggleAttendance(classId, student.stt, session.id, sessionCell);
                    });
                    
                    row.appendChild(sessionCell);
                });
                
                tbody.appendChild(row);
            });
        }
        
        // Thay đổi trạng thái điểm danh
        function toggleAttendance(classId, studentId, session, cell) {
            // Đảm bảo dữ liệu tồn tại
            if (!attendanceData[classId]) {
                attendanceData[classId] = {};
            }
            if (!attendanceData[classId][studentId]) {
                attendanceData[classId][studentId] = {};
            }
            
            // Đảo trạng thái
            const currentStatus = attendanceData[classId][studentId][session];
            attendanceData[classId][studentId][session] = !currentStatus;
            
            // Cập nhật giao diện
            if (attendanceData[classId][studentId][session]) {
                cell.textContent = '✓';
                cell.classList.remove('absent');
                cell.classList.add('present');
            } else {
                cell.textContent = '✗';
                cell.classList.remove('present');
                cell.classList.add('absent');
            }
            
            // Lưu dữ liệu và cập nhật thống kê
            saveAllData();
            updateDashboard();
            showToast('Đã cập nhật điểm danh', 'success');
            
            // Đồng bộ lên Firebase nếu đang online
            if (isOnline) {
                syncToFirebase();
            }
        }
        
        // Đánh dấu tất cả có mặt
        function markAllPresent(classId) {
            if (!confirm('Bạn có chắc chắn muốn đánh dấu tất cả học sinh có mặt?')) {
                return;
            }
            
            const students = classData[classId];
            const sessions = sessionData[classId] || [];
            
            students.forEach(student => {
                sessions.forEach(session => {
                    if (!attendanceData[classId]) {
                        attendanceData[classId] = {};
                    }
                    if (!attendanceData[classId][student.stt]) {
                        attendanceData[classId][student.stt] = {};
                    }
                    
                    attendanceData[classId][student.stt][session.id] = true;
                });
            });
            
            saveAllData();
            displayClass(classId);
            updateDashboard();
            showToast('Đã đánh dấu tất cả học sinh có mặt', 'success');
            
            // Đồng bộ lên Firebase nếu đang online
            if (isOnline) {
                syncToFirebase();
            }
        }
        
        // Đánh dấu tất cả vắng mặt
        function markAllAbsent(classId) {
            if (!confirm('Bạn có chắc chắn muốn đánh dấu tất cả học sinh vắng mặt?')) {
                return;
            }
            
            const students = classData[classId];
            const sessions = sessionData[classId] || [];
            
            students.forEach(student => {
                sessions.forEach(session => {
                    if (!attendanceData[classId]) {
                        attendanceData[classId] = {};
                    }
                    if (!attendanceData[classId][student.stt]) {
                        attendanceData[classId][student.stt] = {};
                    }
                    
                    attendanceData[classId][student.stt][session.id] = false;
                });
            });
            
            saveAllData();
            displayClass(classId);
            updateDashboard();
            showToast('Đã đánh dấu tất cả học sinh vắng mặt', 'success');
            
            // Đồng bộ lên Firebase nếu đang online
            if (isOnline) {
                syncToFirebase();
            }
        }
        
        // Xuất dữ liệu CSV với UTF-8 BOM để đảm bảo hiển thị đúng tiếng Việt
        function exportData(classId) {
            const students = classData[classId];
            const sessions = sessionData[classId] || [];
            
            // Thêm BOM (Byte Order Mark) để đảm bảo UTF-8
            let csvContent = '\uFEFF';
            csvContent += "STT,Họ và tên,SĐT PH";
            
            // Thêm tiêu đề cho các buổi học
            sessions.forEach(session => {
                csvContent += `,${session.name} (${session.date || 'Chưa có ngày'})`;
            });
            csvContent += "\n";
            
            // Thêm dữ liệu học sinh
            students.forEach(student => {
                csvContent += `${student.stt},"${student.name}","${student.phone}"`;
                
                sessions.forEach(session => {
                    const isPresent = attendanceData[classId] && 
                                      attendanceData[classId][student.stt] && 
                                      attendanceData[classId][student.stt][session.id];
                    
                    csvContent += `,${isPresent ? "Có mặt" : "Vắng mặt"}`;
                });
                
                csvContent += "\n";
            });
            
            // Tạo và tải file với encoding UTF-8
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `diem_danh_${classId}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Đã xuất dữ liệu thành công', 'success');
        }
        
        // Xuất dữ liệu Excel (XLSX) - giải pháp tốt nhất cho tiếng Việt
        function exportExcel(classId) {
            const students = classData[classId];
            const sessions = sessionData[classId] || [];
            
            // Tạo workbook và worksheet
            const wb = XLSX.utils.book_new();
            const wsData = [];
            
            // Tạo tiêu đề
            const header = ['STT', 'Họ và tên', 'SĐT PH'];
            sessions.forEach(session => {
                header.push(`${session.name} (${session.date || 'Chưa có ngày'})`);
            });
            wsData.push(header);
            
            // Thêm dữ liệu học sinh
            students.forEach(student => {
                const row = [student.stt, student.name, student.phone];
                
                sessions.forEach(session => {
                    const isPresent = attendanceData[classId] && 
                                      attendanceData[classId][student.stt] && 
                                      attendanceData[classId][student.stt][session.id];
                    
                    row.push(isPresent ? "Có mặt" : "Vắng mặt");
                });
                
                wsData.push(row);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Đặt độ rộng cột
            const colWidths = [
                { wch: 5 },  // STT
                { wch: 25 }, // Họ và tên
                { wch: 15 }, // SĐT PH
            ];
            sessions.forEach(() => {
                colWidths.push({ wch: 20 }); // Mỗi buổi học
            });
            ws['!cols'] = colWidths;
            
            // Thêm worksheet vào workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Điểm danh');
            
            // Xuất file
            XLSX.writeFile(wb, `diem_danh_${classId}_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showToast('Đã xuất file Excel thành công', 'success');
        }
        
        // Hiển thị modal quản lý học sinh
        function showStudentModal() {
            const modal = document.getElementById('studentModal');
            modal.style.display = 'flex';
            currentEditingStudent = null;
            document.getElementById('studentName').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('saveStudentBtn').textContent = 'Thêm học sinh';
        }
        
        // Hiển thị danh sách học sinh trong tab
        function displayStudentList(classId) {
            const students = classData[classId];
            const studentListContainer = document.getElementById('studentListContainer');
            studentListContainer.innerHTML = '';
            
            students.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.style.display = 'flex';
                studentItem.style.justifyContent = 'space-between';
                studentItem.style.alignItems = 'center';
                studentItem.style.padding = '15px';
                studentItem.style.borderBottom = '1px solid #eee';
                studentItem.className = 'fade-in';
                
                const studentInfo = document.createElement('div');
                studentInfo.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${student.stt}. ${student.name}</div>
                    <div style="color: #6c757d; font-size: 0.9rem;">${student.phone || 'Chưa có SĐT'}</div>
                `;
                
                const studentActions = document.createElement('div');
                studentActions.className = 'student-actions';
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Sửa';
                editBtn.className = 'btn-warning';
                editBtn.addEventListener('click', () => editStudent(classId, student.stt));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Xóa';
                deleteBtn.className = 'btn-danger';
                deleteBtn.addEventListener('click', () => deleteStudent(classId, student.stt));
                
                studentActions.appendChild(editBtn);
                studentActions.appendChild(deleteBtn);
                
                studentItem.appendChild(studentInfo);
                studentItem.appendChild(studentActions);
                studentListContainer.appendChild(studentItem);
            });
        }
        
        // Chỉnh sửa học sinh
        function editStudent(classId, studentId) {
            const student = classData[classId].find(s => s.stt === studentId);
            
            if (student) {
                document.getElementById('studentName').value = student.name;
                document.getElementById('studentPhone').value = student.phone;
                currentEditingStudent = { classId, studentId };
                document.getElementById('saveStudentBtn').textContent = 'Cập nhật';
                document.getElementById('studentModal').style.display = 'flex';
            }
        }
        
        // Xóa học sinh
        function deleteStudent(classId, studentId) {
            if (confirm('Bạn có chắc chắn muốn xóa học sinh này?')) {
                classData[classId] = classData[classId].filter(s => s.stt !== studentId);
                
                // Cập nhật lại STT
                classData[classId].forEach((student, index) => {
                    student.stt = index + 1;
                });
                
                saveAllData();
                displayStudentList(classId);
                if (currentClass === classId) {
                    displayClass(classId);
                }
                updateDashboard();
                showToast('Đã xóa học sinh thành công', 'success');
                
                // Đồng bộ lên Firebase nếu đang online
                if (isOnline) {
                    syncToFirebase();
                }
            }
        }
        
        // Lưu học sinh
        function saveStudent() {
            const classId = document.getElementById('studentClassSelect').value;
            const name = document.getElementById('studentName').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            
            if (!name) {
                showToast('Vui lòng nhập họ và tên học sinh', 'error');
                return;
            }
            
            if (currentEditingStudent) {
                // Cập nhật học sinh hiện có
                const student = classData[currentEditingStudent.classId].find(s => s.stt === currentEditingStudent.studentId);
                if (student) {
                    student.name = name;
                    student.phone = phone;
                }
                showToast('Đã cập nhật thông tin học sinh', 'success');
            } else {
                // Thêm học sinh mới
                const newStudent = {
                    stt: classData[classId].length + 1,
                    name: name,
                    phone: phone
                };
                classData[classId].push(newStudent);
                
                // Thêm dữ liệu điểm danh mặc định cho học sinh mới
                if (!attendanceData[classId]) {
                    attendanceData[classId] = {};
                }
                attendanceData[classId][newStudent.stt] = {};
                
                const sessions = sessionData[classId] || [];
                sessions.forEach(session => {
                    attendanceData[classId][newStudent.stt][session.id] = true;
                });
                
                showToast('Đã thêm học sinh mới', 'success');
            }
            
            saveAllData();
            displayStudentList(classId);
            if (currentClass === classId) {
                displayClass(classId);
            }
            updateDashboard();
            closeModal('studentModal');
            
            // Đồng bộ lên Firebase nếu đang online
            if (isOnline) {
                syncToFirebase();
            }
        }
        
        // Hiển thị modal quản lý buổi học
        function showSessionModal() {
            const modal = document.getElementById('sessionModal');
            modal.style.display = 'flex';
            currentEditingSession = null;
            document.getElementById('sessionName').value = '';
            document.getElementById('sessionDateModal').value = '';
            document.getElementById('saveSessionBtn').textContent = 'Thêm buổi học';
        }
        
        // Hiển thị danh sách buổi học trong tab
        function displaySessionList(classId) {
            const sessions = sessionData[classId] || [];
            const sessionListContainer = document.getElementById('sessionListContainer');
            sessionListContainer.innerHTML = '';
            
            sessions.forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.style.display = 'flex';
                sessionItem.style.justifyContent = 'space-between';
                sessionItem.style.alignItems = 'center';
                sessionItem.style.padding = '15px';
                sessionItem.style.borderBottom = '1px solid #eee';
                sessionItem.className = 'fade-in';
                
                const sessionInfo = document.createElement('div');
                sessionInfo.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${session.name}</div>
                    <div style="color: #6c757d; font-size: 0.9rem;">${session.date || 'Chưa có ngày'}</div>
                `;
                
                const sessionActions = document.createElement('div');
                sessionActions.className = 'student-actions';
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Sửa';
                editBtn.className = 'btn-warning';
                editBtn.addEventListener('click', () => editSession(classId, session.id));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Xóa';
                deleteBtn.className = 'btn-danger';
                deleteBtn.addEventListener('click', () => deleteSession(classId, session.id));
                
                sessionActions.appendChild(editBtn);
                sessionActions.appendChild(deleteBtn);
                
                sessionItem.appendChild(sessionInfo);
                sessionItem.appendChild(sessionActions);
                sessionListContainer.appendChild(sessionItem);
            });
        }
        
        // Chỉnh sửa buổi học
        function editSession(classId, sessionId) {
            const session = sessionData[classId].find(s => s.id === sessionId);
            
            if (session) {
                document.getElementById('sessionName').value = session.name;
                document.getElementById('sessionDateModal').value = session.date || '';
                currentEditingSession = { classId, sessionId };
                document.getElementById('saveSessionBtn').textContent = 'Cập nhật';
                document.getElementById('sessionModal').style.display = 'flex';
            }
        }
        
        // Xóa buổi học
        function deleteSession(classId, sessionId) {
            if (confirm('Bạn có chắc chắn muốn xóa buổi học này?')) {
                sessionData[classId] = sessionData[classId].filter(s => s.id !== sessionId);
                
                // Xóa dữ liệu điểm danh của buổi học này
                const students = classData[classId];
                students.forEach(student => {
                    if (attendanceData[classId] && attendanceData[classId][student.stt]) {
                        delete attendanceData[classId][student.stt][sessionId];
                    }
                });
                
                saveAllData();
                displaySessionList(classId);
                if (currentClass === classId) {
                    displayClass(classId);
                }
                showToast('Đã xóa buổi học thành công', 'success');
                
                // Đồng bộ lên Firebase nếu đang online
                if (isOnline) {
                    syncToFirebase();
                }
            }
        }
        
        // Lưu buổi học
        function saveSession() {
            const classId = document.getElementById('sessionClassSelect').value;
            const name = document.getElementById('sessionName').value.trim();
            const date = document.getElementById('sessionDateModal').value;
            
            if (!name) {
                showToast('Vui lòng nhập tên buổi học', 'error');
                return;
            }
            
            if (currentEditingSession) {
                // Cập nhật buổi học hiện có
                const session = sessionData[currentEditingSession.classId].find(s => s.id === currentEditingSession.sessionId);
                if (session) {
                    session.name = name;
                    session.date = date;
                }
                showToast('Đã cập nhật buổi học', 'success');
            } else {
                // Thêm buổi học mới
                const newSession = {
                    id: `B${Date.now()}`, // ID duy nhất
                    name: name,
                    date: date
                };
                
                if (!sessionData[classId]) {
                    sessionData[classId] = [];
                }
                sessionData[classId].push(newSession);
                
                // Thêm dữ liệu điểm danh mặc định cho buổi học mới
                const students = classData[classId];
                students.forEach(student => {
                    if (!attendanceData[classId]) {
                        attendanceData[classId] = {};
                    }
                    if (!attendanceData[classId][student.stt]) {
                        attendanceData[classId][student.stt] = {};
                    }
                    attendanceData[classId][student.stt][newSession.id] = true;
                });
                
                showToast('Đã thêm buổi học mới', 'success');
            }
            
            saveAllData();
            displaySessionList(classId);
            if (currentClass === classId) {
                displayClass(classId);
            }
            closeModal('sessionModal');
            
            // Đồng bộ lên Firebase nếu đang online
            if (isOnline) {
                syncToFirebase();
            }
        }
        
        // Thêm buổi học từ ngày
        function addSessionFromDate() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const date = document.getElementById('sessionDate').value;
            
            if (!date) {
                showToast('Vui lòng chọn ngày học', 'error');
                return;
            }
            
            // Tạo tên buổi học tự động
            const sessionCount = sessionData[classId] ? sessionData[classId].length + 1 : 1;
            const sessionName = `B${sessionCount}`;
            
            // Thêm buổi học mới
            const newSession = {
                id: `B${Date.now()}`,
                name: sessionName,
                date: date
            };
            
            if (!sessionData[classId]) {
                sessionData[classId] = [];
            }
            sessionData[classId].push(newSession);
            
            // Thêm dữ liệu điểm danh mặc định cho buổi học mới
            const students = classData[classId];
            students.forEach(student => {
                if (!attendanceData[classId]) {
                    attendanceData[classId] = {};
                }
                if (!attendanceData[classId][student.stt]) {
                    attendanceData[classId][student.stt] = {};
                }
                attendanceData[classId][student.stt][newSession.id] = true;
            });
            
            saveAllData();
            displayClass(classId);
            document.getElementById('sessionDate').value = '';
            showToast('Đã thêm buổi học mới', 'success');
            
            // Đồng bộ lên Firebase nếu đang online
            if (isOnline) {
                syncToFirebase();
            }
        }
        
        // Tạo báo cáo
        function generateReport(classId) {
            const students = classData[classId];
            const sessions = sessionData[classId] || [];
            const reportContainer = document.getElementById('reportContainer');
            
            // Tính toán thống kê
            let totalSessions = sessions.length;
            let totalPossibleAttendance = students.length * totalSessions;
            let totalPresent = 0;
            
            students.forEach(student => {
                sessions.forEach(session => {
                    if (attendanceData[classId] && 
                        attendanceData[classId][student.stt] && 
                        attendanceData[classId][student.stt][session.id]) {
                        totalPresent++;
                    }
                });
            });
            
            const presentRate = totalPossibleAttendance > 0 ? 
                Math.round((totalPresent / totalPossibleAttendance) * 100) : 0;
            
            // Tạo HTML cho báo cáo
            reportContainer.innerHTML = `
                <div class="report-summary">
                    <div class="report-item">
                        <div class="value">${students.length}</div>
                        <div class="label">Tổng học sinh</div>
                    </div>
                    <div class="report-item">
                        <div class="value">${totalSessions}</div>
                        <div class="label">Tổng buổi học</div>
                    </div>
                    <div class="report-item">
                        <div class="value">${totalPresent}</div>
                        <div class="label">Số lần có mặt</div>
                    </div>
                    <div class="report-item">
                        <div class="value">${presentRate}%</div>
                        <div class="label">Tỷ lệ có mặt</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h4>Thống kê điểm danh theo học sinh</h4>
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Học sinh</th>
                                <th>Số buổi có mặt</th>
                                <th>Tỷ lệ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map(student => {
                                let studentPresent = 0;
                                sessions.forEach(session => {
                                    if (attendanceData[classId] && 
                                        attendanceData[classId][student.stt] && 
                                        attendanceData[classId][student.stt][session.id]) {
                                        studentPresent++;
                                    }
                                });
                                const studentRate = totalSessions > 0 ? 
                                    Math.round((studentPresent / totalSessions) * 100) : 0;
                                
                                return `
                                    <tr>
                                        <td>${student.stt}</td>
                                        <td>${student.name}</td>
                                        <td>${studentPresent}/${totalSessions}</td>
                                        <td>${studentRate}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="actions" style="margin-top: 20px;">
                    <button class="btn-primary" id="exportReportExcel">
                        <i class="fas fa-file-excel"></i> Xuất báo cáo Excel
                    </button>
                </div>
            `;
            
            // Thêm sự kiện cho nút xuất báo cáo Excel
            document.getElementById('exportReportExcel').addEventListener('click', function() {
                exportReportExcel(classId);
            });
        }
        
        // Xuất báo cáo Excel
        function exportReportExcel(classId) {
            const students = classData[classId];
            const sessions = sessionData[classId] || [];
            
            // Tạo workbook
            const wb = XLSX.utils.book_new();
            
            // Tạo worksheet cho thống kê tổng quan
            const summaryData = [
                ['BÁO CÁO ĐIỂM DANH'],
                ['Lớp:', document.getElementById('reportClassSelect').selectedOptions[0].text],
                ['Ngày xuất:', new Date().toLocaleDateString('vi-VN')],
                [],
                ['THỐNG KÊ TỔNG QUAN'],
                ['Tổng học sinh', students.length],
                ['Tổng buổi học', sessions.length],
                ['Tổng số lần có mặt', calculateTotalPresent(classId)],
                ['Tỷ lệ có mặt', `${calculatePresentRate(classId)}%`],
                [],
                ['CHI TIẾT ĐIỂM DANH THEO HỌC SINH']
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            
            // Tạo worksheet cho chi tiết điểm danh
            const detailData = [['STT', 'Họ và tên', 'SĐT PH', 'Số buổi có mặt', 'Tỷ lệ có mặt']];
            
            students.forEach(student => {
                let presentCount = 0;
                sessions.forEach(session => {
                    if (attendanceData[classId] && 
                        attendanceData[classId][student.stt] && 
                        attendanceData[classId][student.stt][session.id]) {
                        presentCount++;
                    }
                });
                const rate = sessions.length > 0 ? Math.round((presentCount / sessions.length) * 100) : 0;
                
                detailData.push([
                    student.stt,
                    student.name,
                    student.phone,
                    presentCount,
                    `${rate}%`
                ]);
            });
            
            const detailWs = XLSX.utils.aoa_to_sheet(detailData);
            
            // Đặt độ rộng cột
            detailWs['!cols'] = [
                { wch: 5 },  // STT
                { wch: 25 }, // Họ và tên
                { wch: 15 }, // SĐT PH
                { wch: 15 }, // Số buổi có mặt
                { wch: 15 }  // Tỷ lệ
            ];
            
            // Thêm các worksheet vào workbook
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Tổng quan');
            XLSX.utils.book_append_sheet(wb, detailWs, 'Chi tiết');
            
            // Xuất file
            const className = document.getElementById('reportClassSelect').selectedOptions[0].text;
            XLSX.writeFile(wb, `Bao_cao_diem_danh_${className}_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showToast('Đã xuất báo cáo Excel thành công', 'success');
        }
        
        // Tính tổng số lần có mặt
        function calculateTotalPresent(classId) {
            const students = classData[classId];
            const sessions = sessionData[classId] || [];
            let totalPresent = 0;
            
            students.forEach(student => {
                sessions.forEach(session => {
                    if (attendanceData[classId] && 
                        attendanceData[classId][student.stt] && 
                        attendanceData[classId][student.stt][session.id]) {
                        totalPresent++;
                    }
                });
            });
            
            return totalPresent;
        }
        
        // Tính tỷ lệ có mặt
        function calculatePresentRate(classId) {
            const students = classData[classId];
            const sessions = sessionData[classId] || [];
            const totalPossible = students.length * sessions.length;
            const totalPresent = calculateTotalPresent(classId);
            
            return totalPossible > 0 ? Math.round((totalPresent / totalPossible) * 100) : 0;
        }
        
        // Sao lưu dữ liệu
        function backupData() {
            const data = {
                classData: classData,
                attendanceData: attendanceData,
                sessionData: sessionData,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_diemdanh_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Đã sao lưu dữ liệu thành công', 'success');
        }
        
        // Đặt lại dữ liệu
        function resetData() {
            if (confirm('Bạn có chắc chắn muốn đặt lại toàn bộ dữ liệu? Hành động này không thể hoàn tác!')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // Đóng modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Chuyển tab
        function switchTab(tabName) {
            // Ẩn tất cả tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hiển thị tab được chọn
            document.getElementById(tabName).classList.add('active');
            
            // Cập nhật nav item active
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-tab="${tabName}"]`).classList.add('active');
            
            // Cập nhật tiêu đề trang
            const pageTitles = {
                dashboard: 'Dashboard',
                attendance: 'Điểm danh',
                students: 'Quản lý học sinh',
                sessions: 'Quản lý buổi học',
                reports: 'Báo cáo',
                settings: 'Cài đặt'
            };
            document.getElementById('pageTitle').textContent = pageTitles[tabName];
            
            // Cập nhật dữ liệu cho tab
            if (tabName === 'students') {
                const classId = document.getElementById('studentClassSelect').value;
                displayStudentList(classId);
            } else if (tabName === 'sessions') {
                const classId = document.getElementById('sessionClassSelect').value;
                displaySessionList(classId);
            } else if (tabName === 'attendance') {
                const classId = document.getElementById('attendanceClassSelect').value;
                displayClass(classId);
            } else if (tabName === 'reports') {
                const classId = document.getElementById('reportClassSelect').value;
                generateReport(classId);
            }
        }
        
        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            // Theo dõi trạng thái kết nối Firebase
            firebase.firestore().enablePersistence()
                .then(() => {
                    // Firebase đã sẵn sàng
                    updateConnectionStatus(true);
                })
                .catch((err) => {
                    console.error('Lỗi khởi tạo Firebase:', err);
                    updateConnectionStatus(false);
                });
            
            // Xử lý sự kiện chuyển tab
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Xử lý sự kiện chọn lớp
            document.getElementById('classSelect').addEventListener('change', function() {
                displayClass(this.value);
            });
            
            document.getElementById('attendanceClassSelect').addEventListener('change', function() {
                displayClass(this.value);
            });
            
            document.getElementById('studentClassSelect').addEventListener('change', function() {
                displayStudentList(this.value);
            });
            
            document.getElementById('sessionClassSelect').addEventListener('change', function() {
                displaySessionList(this.value);
            });
            
            document.getElementById('reportClassSelect').addEventListener('change', function() {
                generateReport(this.value);
            });
            
            // Xử lý sự kiện nút
            document.getElementById('goToAttendanceBtn').addEventListener('click', function() {
                switchTab('attendance');
            });
            
            document.getElementById('saveBtn').addEventListener('click', function() {
                saveAllData();
                showToast('Đã lưu điểm danh!', 'success');
                
                // Đồng bộ lên Firebase nếu đang online
                if (isOnline) {
                    syncToFirebase();
                }
            });
            
            document.getElementById('markAllPresent').addEventListener('click', function() {
                const classId = document.getElementById('attendanceClassSelect').value;
                markAllPresent(classId);
            });
            
            document.getElementById('markAllAbsent').addEventListener('click', function() {
                const classId = document.getElementById('attendanceClassSelect').value;
                markAllAbsent(classId);
            });
            
            document.getElementById('exportBtn').addEventListener('click', function() {
                // Hiển thị modal chọn định dạng xuất
                showExportModal();
            });
            
            document.getElementById('addStudentBtn').addEventListener('click', showStudentModal);
            
            document.getElementById('addSessionBtn').addEventListener('click', addSessionFromDate);
            
            document.getElementById('addNewSessionBtn').addEventListener('click', showSessionModal);
            
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                const classId = document.getElementById('reportClassSelect').value;
                generateReport(classId);
            });
            
            document.getElementById('backupDataBtn').addEventListener('click', backupData);
            
            document.getElementById('resetDataBtn').addEventListener('click', resetData);
            
            document.getElementById('syncDataBtn').addEventListener('click', function() {
                syncToFirebase();
            });
            
            document.getElementById('saveSettingsBtn').addEventListener('click', function() {
                showToast('Đã lưu cài đặt', 'success');
            });
            
            document.getElementById('printBtn').addEventListener('click', function() {
                window.print();
            });
            
            // Xử lý sự kiện modal
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.style.display = 'none';
                });
            });
            
            document.getElementById('cancelStudentBtn').addEventListener('click', function() {
                closeModal('studentModal');
            });
            
            document.getElementById('cancelSessionBtn').addEventListener('click', function() {
                closeModal('sessionModal');
            });
            
            document.getElementById('saveStudentBtn').addEventListener('click', saveStudent);
            
            document.getElementById('saveSessionBtn').addEventListener('click', saveSession);
            
            // Đóng modal khi click bên ngoài
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            // Hiển thị lớp đầu tiên
            displayClass('lop6');
            displayStudentList('lop6');
            displaySessionList('lop6');
        });
        
        // Hiển thị modal chọn định dạng xuất
        function showExportModal() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const className = document.getElementById('attendanceClassSelect').selectedOptions[0].text;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Xuất dữ liệu điểm danh</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Chọn định dạng xuất cho lớp <strong>${className}</strong>:</p>
                        <div class="actions" style="margin-top: 20px; justify-content: center;">
                            <button class="btn-info" id="exportCsvBtn">
                                <i class="fas fa-file-csv"></i> Xuất CSV
                            </button>
                            <button class="btn-success" id="exportExcelBtn">
                                <i class="fas fa-file-excel"></i> Xuất Excel
                            </button>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.9rem; color: #6c757d;">
                            <p><strong>Lưu ý:</strong></p>
                            <ul style="padding-left: 20px;">
                                <li>CSV: Định dạng đơn giản, có thể bị lỗi font với một số phần mềm</li>
                                <li>Excel: Định dạng tốt nhất, hỗ trợ đầy đủ tiếng Việt</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Xử lý sự kiện
            modal.querySelector('.close-btn').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('#exportCsvBtn').addEventListener('click', function() {
                exportData(classId);
                document.body.removeChild(modal);
            });
            
            modal.querySelector('#exportExcelBtn').addEventListener('click', function() {
                exportExcel(classId);
                document.body.removeChild(modal);
            });
            
            // Đóng modal khi click bên ngoài
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
    </script>
    
    <!-- Thêm thư viện SheetJS để xuất Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>