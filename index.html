<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quản lý Trung tâm - Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
  <style>
    /* ------------------------- */
    /* --- THEME & VARIABLES --- */
    /* ------------------------- */
    :root {
      --primary: #4e73df; --secondary: #858796; --success: #1cc88a;
      --info: #36b9cc; --warning: #f6c23e; --danger: #e74a3b;
      --light: #f8f9fc; --dark: #5a5c69; --sidebar-width: 220px;
      --header-height: 60px; --body-bg: #f8f9fc; --card-bg: #fff;
      --border-color: #e3e6f0;
      --box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      --border-radius: 0.35rem;
    }

    /* ----------------- */
    /* --- BASE & LAYOUT --- */
    /* ----------------- */
    body {
      background-color: var(--body-bg);
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      color: var(--dark);
    }
    #wrapper { display: flex; }
    #sidebar {
      width: var(--sidebar-width);
      min-height: 100vh;
      background-color: var(--primary);
      transition: margin-left 0.3s ease;
      z-index: 1030;
    }
    #content-wrapper {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      width: calc(100% - var(--sidebar-width));
    }
    #main-content { padding: 24px; }
    .page-section { display: none; }
    .page-section.active { display: block; }
    
    @media (max-width: 768px) {
      #sidebar { margin-left: calc(-1 * var(--sidebar-width)); }
      #sidebar.toggled { margin-left: 0; }
      #content-wrapper { width: 100%; }
    }

    /* --- LOGIN & LOADING STYLES --- */
    #login-container, #loading-container {
        position: fixed; top: 0; left: 0;
        width: 100vw; height: 100vh;
        background-color: var(--body-bg);
        display: flex; align-items: center; justify-content: center;
        z-index: 2000;
    }
    #login-card { max-width: 400px; width: 100%; }
    .d-none { display: none !important; }

    /* ----------------- */
    /* --- COMPONENTS --- */
    /* ----------------- */
    /* Sidebar */
    .sidebar-brand {
      height: var(--header-height); display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; font-weight: bold; color: #fff; text-decoration: none;
    }
    .sidebar-nav-item {
      display: block; color: rgba(255,255,255,0.8); padding: 1rem 1.5rem;
      text-decoration: none; transition: all 0.2s ease; cursor: pointer;
    }
    .sidebar-nav-item:hover, .sidebar-nav-item.active {
      background-color: rgba(255,255,255,0.1); color: #fff;
    }
    .sidebar-nav-item i { margin-right: 10px; }

    /* Header */
    #header {
      height: var(--header-height); background: var(--card-bg); box-shadow: var(--box-shadow);
      padding: 0 1.5rem; display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 1020;
    }

    /* Cards */
    .card {
      border: 1px solid var(--border-color); box-shadow: var(--box-shadow);
      border-radius: var(--border-radius); margin-bottom: 24px;
    }
    .stat-card {
      border-left: 4px solid var(--primary); transition: transform 0.2s ease-in-out;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card.border-success { border-color: var(--success); }
    .stat-card.border-info { border-color: var(--info); }
    .stat-card.border-warning { border-color: var(--warning); }
    .stat-card.border-danger { border-color: var(--danger); }
    .stat-card .card-body { padding: 1.5rem; }
    .stat-card .stat-icon { font-size: 2rem; opacity: 0.3; }

    /* Conflict List */
    #conflict-card .list-group-item { font-size: 0.9rem; padding: 0.5rem 1rem; }

    /* FullCalendar style */
    .fc {
      --fc-border-color: var(--border-color);
      --fc-today-bg-color: rgba(78, 115, 223, 0.05);
      --fc-page-bg-color: transparent;
      height: 75vh;
    }
    .fc .fc-toolbar-title { font-size: 1.25rem; }
    .fc-event {
        padding: 4px 6px; font-size: 0.8em; border-radius: 4px;
        cursor: pointer; color: #fff !important;
    }
    .fc-event.conflict-event {
        background-color: var(--danger) !important;
        border: 2px dashed #fff !important;
    }
    
    /* ----------------- */
    /* --- UTILITIES --- */
    /* ----------------- */
    .text-primary { color: var(--primary) !important; }
    .text-danger { color: var(--danger) !important; }
    .table-responsive-cards .no-data-row td { text-align: center; color: var(--secondary); font-style: italic; }

    /* Responsive table */
    @media (max-width: 767px) {
        .table-responsive-cards thead { display: none; }
        .table-responsive-cards tr {
            display: block; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius);
        }
        .table-responsive-cards td {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; border-top: 1px solid var(--border-color); text-align: right;
        }
        .table-responsive-cards tr td:first-child { border-top: none; }
        .table-responsive-cards td::before {
            content: attr(data-label); font-weight: 600; margin-right: auto; text-align: left;
        }
    }
  </style>
</head>
<body>

  <div id="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div id="login-container" class="d-none">
    <div id="login-card" class="card shadow-lg">
      <div class="card-body p-5">
        <div class="text-center mb-4">
          <i class="bi bi-calendar-check fs-1 text-primary"></i>
          <h3 class="mt-2">TRUNG TÂM KỸ NĂNG</h3>
          <p class="text-secondary">Vui lòng đăng nhập để tiếp tục</p>
        </div>
        <form id="loginForm">
          <div class="form-floating mb-3">
            <input type="email" class="form-control" id="loginEmail" placeholder="name@example.com" required>
            <label for="loginEmail">Email</label>
          </div>
          <div class="form-floating mb-3">
            <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
            <label for="loginPassword">Mật khẩu</label>
          </div>
          <div id="loginError" class="alert alert-danger d-none" role="alert"></div>
          <div class="d-grid">
            <button type="submit" id="loginBtn" class="btn btn-primary btn-lg">
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              <span class="button-text">Đăng nhập</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <div id="wrapper" class="d-none">
    <nav id="sidebar">
      <a class="sidebar-brand" href="#">
        <i class="bi bi-calendar-check"></i>
        <span>TRUNG TÂM</span>
      </a>
      <a class="sidebar-nav-item active" data-target="dashboard-page"><i class="bi bi-speedometer2"></i> Dashboard</a>
      <a class="sidebar-nav-item" data-target="classes-page"><i class="bi bi-easel"></i> Lớp học</a>
      <a class="sidebar-nav-item admin-only" data-target="teachers-page"><i class="bi bi-person-video3"></i> Giáo viên</a>
      <a class="sidebar-nav-item hide-from-student" data-target="students-page"><i class="bi bi-people"></i> Học sinh</a>
      </nav>

    <div id="content-wrapper">
      <header id="header">
          <button id="sidebar-toggle" class="btn d-md-none"><i class="bi bi-list"></i></button>
          <div class="input-group" style="max-width: 400px;">
              <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm...">
              <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn"><i class="bi bi-x-lg"></i></button>
          </div>
          <div class="ms-auto d-flex align-items-center">
              <span id="userDisplayName" class="d-none d-lg-inline me-2 text-secondary"></span>
              <i class="bi bi-person-circle fs-3 text-primary me-3"></i>
              <button id="logoutBtn" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right me-1"></i>Đăng xuất</button>
          </div>
      </header>

      <main id="main-content">

        <div id="dashboard-page" class="page-section active">
          <div class="row">
            <div class="col-xl-3 col-md-6 mb-4"><div class="card stat-card border-info"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-xs fw-bold text-info text-uppercase mb-1">Lớp học</div><div id="stats-classes" class="h5 mb-0 fw-bold">0</div></div><div class="stat-icon"><i class="bi bi-easel"></i></div></div></div></div>
            <div class="col-xl-3 col-md-6 mb-4 admin-only"><div class="card stat-card border-success"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-xs fw-bold text-success text-uppercase mb-1">Giáo viên</div><div id="stats-teachers" class="h5 mb-0 fw-bold">0</div></div><div class="stat-icon"><i class="bi bi-person-video3"></i></div></div></div></div>
            <div class="col-xl-3 col-md-6 mb-4 hide-from-student"><div class="card stat-card border-primary"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-xs fw-bold text-primary text-uppercase mb-1">Học sinh</div><div id="stats-students" class="h5 mb-0 fw-bold">0</div></div><div class="stat-icon"><i class="bi bi-people"></i></div></div></div></div>
            <div class="col-xl-3 col-md-6 mb-4"><div class="card stat-card border-danger"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-xs fw-bold text-danger text-uppercase mb-1">Xung đột lịch</div><div id="stats-conflicts" class="h5 mb-0 fw-bold">0</div></div><div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div></div></div></div>
          </div>
          
          <div id="conflict-card" class="card border-danger" style="display: none;">
              <div class="card-header bg-danger text-white"><h6 class="mb-0 fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>Chi tiết các xung đột lịch</h6></div>
              <div class="card-body p-0"><ul class="list-group list-group-flush" id="conflict-details-list"></ul></div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
                  <h5 class="mb-0 text-primary fw-bold me-3"><i class="bi bi-calendar-week me-2"></i>Thời khóa biểu</h5>
                  <div class="d-flex align-items-center ms-auto">
                      <div class="me-2 admin-only">
                        <label for="teacher-filter-select" class="visually-hidden">Lọc theo giáo viên</label>
                        <select id="teacher-filter-select" class="form-select form-select-sm">
                            <option value="all">Tất cả giáo viên</option>
                        </select>
                      </div>
                      <div class="btn-group" role="group" id="calendar-view-buttons">
                        <button data-view="dayGridMonth" class="btn btn-sm btn-outline-primary">Tháng</button>
                        <button data-view="timeGridWeek" class="btn btn-sm btn-outline-primary active">Tuần</button>
                        <button data-view="timeGridDay" class="btn btn-sm btn-outline-primary">Ngày</button>
                      </div>
                  </div>
                </div>
                <div class="card-body"><div id="calendar"></div></div>
              </div>
            </div>
          </div>
        </div>

        <div id="classes-page" class="page-section">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary fw-bold"><i class="bi bi-easel me-2"></i>Danh sách lớp học</h5>
                <button class="btn btn-success admin-only" data-bs-toggle="modal" data-bs-target="#addClassModal"><i class="bi bi-plus-circle me-1"></i>Thêm lớp mới</button>
              </div>
              <div class="card-body">
                <div class="table-responsive table-responsive-cards">
                  <table class="table table-striped table-hover" id="classesTable">
                  <thead class="table-light"><tr><th>Tên lớp</th><th>Môn</th><th>Giáo viên</th><th>HS</th><th>Lịch học</th><th class="admin-only">Hành động</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
        </div>
        
        <div id="teachers-page" class="page-section">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary fw-bold"><i class="bi bi-person-video3 me-2"></i>Danh sách giáo viên</h5>
                <button class="btn btn-success admin-only" data-bs-toggle="modal" data-bs-target="#addTeacherModal"><i class="bi bi-plus-circle me-1"></i>Thêm giáo viên</button>
              </div>
              <div class="card-body">
                 <div class="table-responsive table-responsive-cards">
                  <table class="table table-hover" id="teachersTable">
                  <thead class="table-light"><tr><th>Tên</th><th>Email</th><th>Môn Dạy</th><th class="admin-only">Hành động</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
        </div>

        <div id="students-page" class="page-section">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary fw-bold"><i class="bi bi-people me-2"></i>Danh sách học sinh</h5>
                <button class="btn btn-success admin-only" data-bs-toggle="modal" data-bs-target="#addStudentModal"><i class="bi bi-plus-circle me-1"></i>Thêm học sinh</button>
              </div>
              <div class="card-body">
                 <div class="table-responsive table-responsive-cards">
                  <table class="table table-hover" id="studentsTable">
                  <thead class="table-light"><tr><th>Tên</th><th>Email</th><th>Lớp đã đăng ký</th><th class="admin-only">Hành động</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
        </div>
      </main>
    </div>
  </div>

  <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

  <div class="modal fade" id="addTeacherModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="addTeacherForm" class="needs-validation" novalidate><div class="modal-header"><h5 class="modal-title">Thêm Giáo viên</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-2"><label class="form-label">Tên</label><input id="teacherName" class="form-control" required><div class="invalid-feedback">Vui lòng nhập tên.</div></div><div class="mb-2"><label class="form-label">Email</label><input id="teacherEmail" class="form-control" type="email" required><div class="invalid-feedback">Vui lòng nhập email hợp lệ.</div></div><div class="mb-2"><label class="form-label">SĐT</label><input id="teacherPhone" class="form-control"></div><div class="mb-2"><label class="form-label">Môn</label><select id="teacherSubject" class="form-select" required><option selected disabled value="">Chọn môn...</option><option value="math">Toán</option><option value="physics">Vật lý</option><option value="chemistry">Hóa</option><option value="literature">Ngữ văn</option><option value="english">Tiếng Anh</option><option value="history">Lịch sử</option><option value="geography">Địa lý</option></select><div class="invalid-feedback">Vui lòng chọn môn học.</div></div></div><div class="modal-footer"><button type="submit" id="saveTeacherBtn" class="btn btn-primary"><span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span><span class="button-text">Lưu</span></button></div></form></div></div></div>
  <div class="modal fade" id="editTeacherModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="editTeacherForm" class="needs-validation" novalidate><div class="modal-header"><h5 class="modal-title">Sửa Giáo viên</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editTeacherId"><div class="mb-2"><label class="form-label">Tên</label><input id="editTeacherName" class="form-control" required></div><div class="mb-2"><label class="form-label">Email</label><input id="editTeacherEmail" class="form-control" type="email" required></div><div class="mb-2"><label class="form-label">SĐT</label><input id="editTeacherPhone" class="form-control"></div><div class="mb-2"><label class="form-label">Môn</label><select id="editTeacherSubject" class="form-select" required><option value="math">Toán</option><option value="physics">Vật lý</option><option value="chemistry">Hóa</option><option value="literature">Ngữ văn</option><option value="english">Tiếng Anh</option><option value="history">Lịch sử</option><option value="geography">Địa lý</option></select></div><div class="text-muted small">Lưu ý: thay đổi email trong Authentication yêu cầu xử lý riêng.</div></div><div class="modal-footer"><button type="submit" id="updateTeacherBtn" class="btn btn-primary"><span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span><span class="button-text">Cập nhật</span></button></div></form></div></div></div>
  <div class="modal fade" id="addStudentModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="addStudentForm" class="needs-validation" novalidate><div class="modal-header"><h5 class="modal-title">Thêm Học sinh</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-2"><label class="form-label">Tên</label><input id="studentName" class="form-control" required></div><div class="mb-2"><label class="form-label">Email</label><input id="studentEmail" class="form-control" type="email" required></div><div class="mb-2"><label class="form-label">SĐT</label><input id="studentPhone" class="form-control"></div><div class="mb-2"><label class="form-label">Chọn lớp (Ctrl/Shift chọn nhiều)</label><select id="studentClass" class="form-select" multiple size="5"></select></div></div><div class="modal-footer"><button type="submit" id="saveStudentBtn" class="btn btn-primary"><span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span><span class="button-text">Lưu</span></button></div></form></div></div></div>
  <div class="modal fade" id="editStudentModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="editStudentForm" class="needs-validation" novalidate><div class="modal-header"><h5 class="modal-title">Sửa Học sinh</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editStudentId"><div class="mb-2"><label class="form-label">Tên</label><input id="editStudentName" class="form-control" required></div><div class="mb-2"><label class="form-label">Email</label><input id="editStudentEmail" class="form-control" type="email" required></div><div class="mb-2"><label class="form-label">SĐT</label><input id="editStudentPhone" class="form-control"></div><div class="mb-2"><label class="form-label">Chọn lớp (Ctrl/Shift chọn nhiều)</label><select id="editStudentClass" class="form-select" multiple size="5"></select></div><div class="text-muted small">Lưu ý: để thay đổi email trong Authentication cần thao tác riêng.</div></div><div class="modal-footer"><button type="submit" id="updateStudentBtn" class="btn btn-primary"><span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span><span class="button-text">Cập nhật</span></button></div></form></div></div></div>
  <div class="modal fade" id="addClassModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><form id="addClassForm" class="needs-validation" novalidate><div class="modal-header"><h5 class="modal-title">Thêm Lớp</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col-md-6"><div class="mb-2"><label class="form-label">Tên lớp</label><input id="className" class="form-control" required></div><div class="mb-2"><label class="form-label">Môn</label><select id="classSubject" class="form-select" required><option selected disabled value="">Chọn môn...</option><option value="math">Toán</option><option value="physics">Vật lý</option><option value="chemistry">Hóa</option><option value="literature">Ngữ văn</option><option value="english">Tiếng Anh</option><option value="history">Lịch sử</option><option value="geography">Địa lý</option></select></div><div class="mb-2"><label class="form-label">Giáo viên</label><select id="classTeacher" class="form-select" required></select></div></div><div class="col-md-6"><p class="fw-bold border-bottom pb-1">Buổi học 1</p><div class="mb-2"><label class="form-label">Phòng</label><input id="classRoom" class="form-control" placeholder="101..."><div class="invalid-feedback">Vui lòng nhập phòng học.</div></div><div class="mb-2 row"><div class="col-6"><label class="form-label">Ngày</label><select id="classDay" class="form-select" required><option value="1">Thứ 2</option><option value="2">Thứ 3</option><option value="3">Thứ 4</option><option value="4">Thứ 5</option><option value="5">Thứ 6</option><option value="6">Thứ 7</option><option value="0">Chủ nhật</option></select></div><div class="col-6"><label class="form-label">Khung giờ</label><select id="classTime" class="form-select" required></select></div></div><hr><p class="fw-bold border-bottom pb-1">Buổi học 2 (tùy chọn)</p><div class="mb-2"><label class="form-label">Phòng</label><input id="classRoom2" class="form-control" placeholder="102..."></div><div class="mb-2 row"><div class="col-6"><label class="form-label">Ngày</label><select id="classDay2" class="form-select"><option value="">-- Không chọn --</option><option value="1">Thứ 2</option><option value="2">Thứ 3</option><option value="3">Thứ 4</option><option value="4">Thứ 5</option><option value="5">Thứ 6</option><option value="6">Thứ 7</option><option value="0">Chủ nhật</option></select></div><div class="col-6"><label class="form-label">Khung giờ</label><select id="classTime2" class="form-select"></select></div></div></div></div></div><div class="modal-footer"><button type="submit" id="saveClassBtn" class="btn btn-primary"><span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span><span class="button-text">Lưu lớp</span></button></div></form></div></div></div>
  <div class="modal fade" id="editClassModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><form id="editClassForm" class="needs-validation" novalidate><div class="modal-header"><h5 class="modal-title">Sửa Lớp</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editClassId"><div class="row"><div class="col-md-6"><div class="mb-2"><label class="form-label">Tên lớp</label><input id="editClassName" class="form-control" required></div><div class="mb-2"><label class="form-label">Môn</label><select id="editClassSubject" class="form-select" required><option value="math">Toán</option><option value="physics">Vật lý</option><option value="chemistry">Hóa</option><option value="literature">Ngữ văn</option><option value="english">Tiếng Anh</option><option value="history">Lịch sử</option><option value="geography">Địa lý</option></select></div><div class="mb-2"><label class="form-label">Giáo viên</label><select id="editClassTeacher" class="form-select" required></select></div></div><div class="col-md-6"><p class="fw-bold border-bottom pb-1">Buổi học 1</p><div class="mb-2"><label class="form-label">Phòng</label><input id="editClassRoom" class="form-control" placeholder="101..." required></div><div class="mb-2 row"><div class="col-6"><label class="form-label">Ngày</label><select id="editClassDay" class="form-select" required><option value="1">Thứ 2</option><option value="2">Thứ 3</option><option value="3">Thứ 4</option><option value="4">Thứ 5</option><option value="5">Thứ 6</option><option value="6">Thứ 7</option><option value="0">Chủ nhật</option></select></div><div class="col-6"><label class="form-label">Khung giờ</label><select id="editClassTime" class="form-select" required></select></div></div><hr><p class="fw-bold border-bottom pb-1">Buổi học 2 (tùy chọn)</p><div class="mb-2"><label class="form-label">Phòng</label><input id="editClassRoom2" class="form-control" placeholder="102..."></div><div class="mb-2 row"><div class="col-6"><label class="form-label">Ngày</label><select id="editClassDay2" class="form-select"><option value="">-- Không chọn --</option><option value="1">Thứ 2</option><option value="2">Thứ 3</option><option value="3">Thứ 4</option><option value="4">Thứ 5</option><option value="5">Thứ 6</option><option value="6">Thứ 7</option><option value="0">Chủ nhật</option></select></div><div class="col-6"><label class="form-label">Khung giờ</label><select id="editClassTime2" class="form-select"></select></div></div></div></div><div class="text-muted small mt-2">Lưu ý: Thao tác này sẽ tự động cập nhật lại thời khóa biểu cho lớp học.</div></div><div class="modal-footer"><button type="submit" id="updateClassBtn" class="btn btn-primary"><span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span><span class="button-text">Cập nhật</span></button></div></form></div></div></div>
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="deleteConfirmModalLabel">Xác nhận xóa</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="deleteConfirmModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button></div></div></div></div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ------------------------------------
    // --- 1. CONFIG & INITIALIZATION ---
    // ------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyAPcaScN-HrCcxiUz_J1QrrREF9sxCfvD8",
      authDomain: "mathhubvn.firebaseapp.com",
      projectId: "mathhubvn",
      storageBucket: "mathhubvn.appspot.com",
      messagingSenderId: "1001364433767",
      appId: "1:1001364433767:web:ae1547dc7d1524a6319dc2",
      measurementId: "G-2YNQZ48JVK"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Global State
    let currentUserProfile = null; // Store user profile with role
    let classes = [], teachers = [], students = [], schedule = [];
    let calendar = null;
    let deleteConfirmModalInstance = null;
    let unsubscribeListeners = []; // To detach listeners on logout

    const TIME_SLOTS = [
      { id: 'slot1', start: '07:00', end: '09:00', name: '07:00-09:00' }, 
      { id: 'slot2', start: '09:15', end: '11:15', name: '09:15-11:15' },
      { id: 'slot3', start: '14:00', end: '16:00', name: '14:00-16:00' }, 
      { id: 'slot4', start: '16:30', end: '18:30', name: '16:30-18:30' },
      { id: 'slot5', start: '19:00', end: '21:00', name: '19:00-21:00' }
    ];
    const DAY_MAP = { monday: 1, tuesday: 2, wednesday: 3, thursday: 4, friday: 5, saturday: 6, sunday: 0 };
    const REVERSE_DAY_MAP = { 1: 'monday', 2: 'tuesday', 3: 'wednesday', 4: 'thursday', 5: 'friday', 6: 'saturday', 0: 'sunday' };
    
    // ------------------------------------
    // --- 2. UI & HELPER FUNCTIONS ---
    // ------------------------------------
    
    function showToast(message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) return;
        const icons = { success: 'bi-check-circle-fill', error: 'bi-x-circle-fill', warning: 'bi-exclamation-triangle-fill', info: 'bi-info-circle-fill' };
        const bgColors = { success: 'bg-success', error: 'bg-danger', warning: 'bg-warning', info: 'bg-info' };
        const toastId = 'toast-' + Date.now();
        const toastHTML = `<div id="${toastId}" class="toast align-items-center text-white ${bgColors[type] || 'bg-secondary'} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body"><i class="bi ${icons[type] || 'bi-bell-fill'} me-2"></i>${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }

    function logError(e, context = 'Lỗi không xác định') { 
        console.error(context, e); 
        showToast(`${context}: ${e.message || e}`, 'error'); 
    }

    function setButtonLoadingState(button, isLoading) {
        if (!button) return;
        const buttonText = button.querySelector('.button-text');
        const spinner = button.querySelector('.spinner-border');
        button.disabled = isLoading;
        if (isLoading) {
            buttonText?.classList.add('d-none');
            spinner?.classList.remove('d-none');
        } else {
            buttonText?.classList.remove('d-none');
            spinner?.classList.add('d-none');
        }
    }

    function showDeleteConfirmModal(title, body, onConfirmCallback) {
        document.getElementById('deleteConfirmModalLabel').textContent = title;
        document.getElementById('deleteConfirmModalBody').innerHTML = body;
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener('click', () => {
            onConfirmCallback();
            deleteConfirmModalInstance.hide();
        }, { once: true });
        deleteConfirmModalInstance.show();
    }


    // Data mapping helpers
    const getSubjectName = (id) => ({math:'Toán',physics:'Vật lý',chemistry:'Hóa',literature:'Ngữ văn',english:'Tiếng Anh',history:'Lịch sử',geography:'Địa lý'}[id]||'');
    const getTeacherName = (id) => teachers.find(x=>x.id===id)?.name || 'N/A';
    const getClassName = (id) => classes.find(x=>x.id===id)?.name || 'N/A';
    const getStudentName = (id) => students.find(x=>x.id===id)?.name || 'N/A';
    const getDayName = (dayKey) => ({monday:'Thứ 2',tuesday:'Thứ 3',wednesday:'Thứ 4',thursday:'Thứ 5',friday:'Thứ 6',saturday:'Thứ 7',sunday:'CN'}[dayKey]||'');
    const getTimeSlotName = (id) => TIME_SLOTS.find(x=>x.id===id)?.name || '';

    function stringToColor(str) {
        if (!str) return '#858796'; // Default color
        let hash = 0;
        for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
        let color = '#';
        for (let i = 0; i < 3; i++) {
            let value = (hash >> (i * 8)) & 0xFF;
            color += ('00' + (Math.floor((value + 180))).toString(16)).substr(-2);
        }
        return color;
    }

    // ------------------------------------
    // --- 3. CORE LOGIC & DATA HANDLING ---
    // ------------------------------------
    
    function detachAllListeners() {
        unsubscribeListeners.forEach(unsubscribe => unsubscribe());
        unsubscribeListeners = [];
    }

    function loadAllData(){
      detachAllListeners(); // Detach old listeners before attaching new ones

      let classesQuery = db.collection('classes');
      let teachersQuery = db.collection('users').where('role', '==', 'teacher');
      let studentsQuery = db.collection('users').where('role', '==', 'student');
      let scheduleQuery = db.collection('schedule');

      if (currentUserProfile.role === 'teacher') {
          classesQuery = classesQuery.where('teacherId', '==', currentUserProfile.uid);
          scheduleQuery = scheduleQuery.where('teacherId', '==', currentUserProfile.uid);
          // For a teacher, we might want to load all students, but filter them client-side for classes they teach.
          // Or, fetch only students in their classes - this is more complex. Let's filter client-side for now.
      } else if (currentUserProfile.role === 'student') {
          classesQuery = classesQuery.where('students', 'array-contains', currentUserProfile.uid);
          scheduleQuery = scheduleQuery.where('classId', 'in', currentUserProfile.classes || ['dummy_id']); // 'in' query requires a non-empty array
      }
      
      const collections = {
          'classes': { query: classesQuery, setter: (data) => classes = data },
          'schedule': { query: scheduleQuery, setter: (data) => schedule = data },
          // Teachers and students are loaded differently based on role for simplicity. Admin sees all.
      };
      
      Object.entries(collections).forEach(([name, {query, setter}]) => {
        const unsubscribe = query.onSnapshot(snap => {
          setter(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          updateUI();
        }, e => logError(e, `Lỗi tải ${name}`));
        unsubscribeListeners.push(unsubscribe);
      });
      
      // Admin sees all teachers and students. Teacher/Student views are filtered client-side or restricted.
      const unsubscribeTeachers = db.collection('users').where('role','==','teacher').onSnapshot(snap => {
        teachers = snap.docs.map(d => ({ id:d.id, ...d.data() })); 
        if(currentUserProfile.role === 'admin') updateUI(); // Only admins need the full list for management
      }, e => logError(e, 'Lỗi tải giáo viên'));

      const unsubscribeStudents = db.collection('users').where('role','==','student').onSnapshot(snap => {
        students = snap.docs.map(d => ({ id:d.id, ...d.data() })); 
        updateUI(); // All roles might need student names, so update
      }, e => logError(e, 'Lỗi tải học sinh'));

      unsubscribeListeners.push(unsubscribeTeachers, unsubscribeStudents);
    }
    
    function updateUI() {
        renderClasses(); renderTeachers(); renderStudents();
        updateClassDropdowns(); updateTeacherDropdowns();
        updateTeacherFilterDropdown();
        updateStats(); renderConflicts();
        if(calendar) calendar.refetchEvents();
    }
    
    function detectConflicts(){
      const conflicts = [];
      const scheduleMap = new Map();
      
      schedule.forEach(s => {
          const key = `${s.day}-${s.time}`;
          if (!scheduleMap.has(key)) scheduleMap.set(key, []);
          scheduleMap.get(key).push(s);
      });

      for(const entries of scheduleMap.values()){
          if(entries.length < 2) continue;
          for(let i=0; i<entries.length; i++){
              for(let j=i+1; j<entries.length; j++){
                  const s1 = entries[i];
                  const s2 = entries[j];
                  if(s1.teacherId && s1.teacherId === s2.teacherId) conflicts.push({type:'teacher', s1, s2});
                  if(s1.room && s1.room === s2.room) conflicts.push({type:'room', s1, s2});
                  
                  const c1 = classes.find(c => c.id === s1.classId);
                  const c2 = classes.find(c => c.id === s2.classId);
                  if(c1?.students && c2?.students) {
                    const commonStudents = c1.students.filter(stId => c2.students.includes(stId));
                    commonStudents.forEach(studentId => {
                        conflicts.push({ type: 'student', studentId, s1, s2 });
                    });
                  }
              }
          }
      }
      return conflicts;
    }

    // ------------------------------------
    // --- 4. RENDER & UPDATE FUNCTIONS ---
    // ------------------------------------

    function updateStats() {
      document.getElementById('stats-classes').textContent = classes.length;
      document.getElementById('stats-teachers').textContent = teachers.length;
      
      // Filter students for teachers
      if(currentUserProfile.role === 'teacher') {
        const studentIdsInMyClasses = new Set(classes.flatMap(c => c.students || []));
        document.getElementById('stats-students').textContent = studentIdsInMyClasses.size;
      } else {
        document.getElementById('stats-students').textContent = students.length;
      }

      document.getElementById('stats-conflicts').textContent = detectConflicts().length;
    }
    
    function renderConflicts() {
        const conflictList = detectConflicts();
        const container = document.getElementById('conflict-card');
        const listElement = document.getElementById('conflict-details-list');
        if (!container || !listElement) return;

        container.style.display = conflictList.length === 0 ? 'none' : 'block';
        if (conflictList.length > 0) {
            listElement.innerHTML = conflictList.map(c => {
                const timeInfo = `<strong>${getDayName(c.s1.day)} ${getTimeSlotName(c.s1.time)}</strong>`;
                const class1Name = getClassName(c.s1.classId);
                const class2Name = getClassName(c.s2.classId);

                if (c.type === 'teacher') return `<li class="list-group-item"><i class="bi bi-person-video3 text-danger me-2"></i><strong>GV Trùng Lịch:</strong> ${getTeacherName(c.s1.teacherId)} dạy lớp '<strong>${class1Name}</strong>' và '<strong>${class2Name}</strong>' cùng lúc (${timeInfo}).</li>`;
                if (c.type === 'room') return `<li class="list-group-item"><i class="bi bi-door-open text-danger me-2"></i><strong>Phòng Trùng Lịch:</strong> Phòng ${c.s1.room} được sử dụng bởi lớp '<strong>${class1Name}</strong>' và '<strong>${class2Name}</strong>' cùng lúc (${timeInfo}).</li>`;
                if (c.type === 'student') return `<li class="list-group-item"><i class="bi bi-person text-danger me-2"></i><strong>HS Trùng Lịch:</strong> HS ${getStudentName(c.studentId)} bị trùng lịch giữa lớp '<strong>${class1Name}</strong>' và '<strong>${class2Name}</strong>' (${timeInfo}).</li>`;
                return '';
            }).join('');
        }
    }

    function renderTable(tableId, data, renderRowCallback) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      if(!tbody) return;
      if (data.length === 0) {
        const colCount = tbody.previousElementSibling.querySelector('tr').cells.length;
        tbody.innerHTML = `<tr class="no-data-row"><td colspan="${colCount}">Chưa có dữ liệu</td></tr>`;
      } else {
        tbody.innerHTML = data.map(renderRowCallback).join('');
      }
    }

    function renderClasses(){
      renderTable('classesTable', classes, c => {
        const teacherName = getTeacherName(c.teacherId);
        const s1 = `${getDayName(c.day)} ${getTimeSlotName(c.time)} (P:${c.room||'?'})`;
        const s2 = c.day2 ? `<br>${getDayName(c.day2)} ${getTimeSlotName(c.time2)} (P:${c.room2||'?'})` : '';
        const searchContent = `${c.name} ${getSubjectName(c.subject)} ${teacherName}`.toLowerCase();
        return `<tr data-search-content="${searchContent}">
                  <td data-label="Tên lớp">${c.name}</td>
                  <td data-label="Môn">${getSubjectName(c.subject)}</td>
                  <td data-label="Giáo viên">${teacherName}</td>
                  <td data-label="HS">${(c.students||[]).length}</td>
                  <td data-label="Lịch học">${s1}${s2}</td>
                  <td data-label="Hành động" class="admin-only">
                    <button class="btn btn-sm btn-outline-primary edit-class" data-id="${c.id}"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger delete-class" data-id="${c.id}" data-name="${c.name}"><i class="bi bi-trash"></i></button>
                  </td>
                </tr>`;
      });
      setupUIVisibility(currentUserProfile.role); // Re-apply visibility rules
    }

    function renderTeachers(){
      // Only admin can see the full teacher list on this page
      const dataToShow = currentUserProfile.role === 'admin' ? teachers : [];
      renderTable('teachersTable', dataToShow, t => {
        const searchContent = `${t.name} ${t.email}`.toLowerCase();
        return `<tr data-search-content="${searchContent}">
                  <td data-label="Tên">${t.name}</td>
                  <td data-label="Email">${t.email||''}</td>
                  <td data-label="Môn">${getSubjectName(t.subject)}</td>
                  <td data-label="Hành động" class="admin-only">
                    <button class="btn btn-sm btn-outline-primary edit-teacher" data-id="${t.id}"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger delete-teacher" data-id="${t.id}" data-name="${t.name}"><i class="bi bi-trash"></i></button>
                  </td>
                </tr>`;
      });
      setupUIVisibility(currentUserProfile.role);
    }

    function renderStudents(){
      let dataToShow = students;
      if (currentUserProfile.role === 'teacher') {
          const studentIdsInMyClasses = new Set(classes.flatMap(c => c.students || []));
          dataToShow = students.filter(s => studentIdsInMyClasses.has(s.id));
      } else if (currentUserProfile.role === 'student') {
          dataToShow = []; // Students don't see the student list page
      }

      renderTable('studentsTable', dataToShow, s => {
        const registeredClasses = (s.classes || []).map(getClassName).join(', ') || 'Chưa đăng ký';
        const searchContent = `${s.name} ${s.email}`.toLowerCase();
        return `<tr data-search-content="${searchContent}">
                  <td data-label="Tên">${s.name}</td>
                  <td data-label="Email">${s.email||''}</td>
                  <td data-label="Lớp">${registeredClasses}</td>
                  <td data-label="Hành động" class="admin-only">
                    <button class="btn btn-sm btn-outline-primary edit-student" data-id="${s.id}"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger delete-student" data-id="${s.id}" data-name="${s.name}"><i class="bi bi-trash"></i></button>
                  </td>
                </tr>`;
      });
      setupUIVisibility(currentUserProfile.role);
    }
    
    function initializeCalendar() {
        const calendarEl = document.getElementById('calendar');
        if (!calendarEl || calendar) return;
        const isAdmin = currentUserProfile.role === 'admin';
        calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'vi', firstDay: 1, 
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
            initialView: 'timeGridWeek',
            slotMinTime: '07:00:00', slotMaxTime: '22:00:00',
            allDaySlot: false, 
            editable: isAdmin, // Only admin can drag-drop to edit
            eventDisplay: 'block', 
            events: (fetchInfo, successCallback, failureCallback) => {
                let filteredSchedule = schedule;
                if (isAdmin) {
                    const selectedTeacherId = document.getElementById('teacher-filter-select').value;
                    if (selectedTeacherId !== 'all') {
                        filteredSchedule = schedule.filter(s => s.teacherId === selectedTeacherId);
                    }
                }
                
                const conflicts = detectConflicts();
                const conflictIds = new Set(conflicts.flatMap(c => [c.s1.id, c.s2.id]));
                
                const calendarEvents = filteredSchedule.map(s => {
                    const cls = classes.find(c => c.id === s.classId);
                    const timeSlot = TIME_SLOTS.find(ts => ts.id === s.time);
                    if (!cls || !timeSlot) return null;
                    const dayNumber = DAY_MAP[s.day];
                    if (dayNumber === undefined) return null;
                    const color = s.teacherId ? stringToColor(s.teacherId) : '#4e73df';
                    return {
                        id: s.id, title: `${cls.name} (P: ${s.room || '?'})`,
                        daysOfWeek: [dayNumber], 
                        startTime: timeSlot.start, endTime: timeSlot.end,
                        backgroundColor: color, borderColor: color,
                        extendedProps: { classId: cls.id, originalDay: s.day, originalTime: s.time, description: `GV: ${getTeacherName(s.teacherId)}`},
                        className: conflictIds.has(s.id) ? 'conflict-event' : '',
                    };
                }).filter(Boolean);
                successCallback(calendarEvents);
            },
            eventClick: (info) => { 
                if (isAdmin) populateEditClassModal(info.event.extendedProps.classId); 
            },
            eventDrop: async (info) => {
              const scheduleId = info.event.id;
              const newDate = info.event.start;
              const newDayKey = REVERSE_DAY_MAP[newDate.getDay()];
              let newTimeSlotId = null;
              let minDiff = Infinity;
              
              const newEventTime = newDate.getHours() * 60 + newDate.getMinutes();
              TIME_SLOTS.forEach(slot => {
                  const [h, m] = slot.start.split(':');
                  const slotTime = parseInt(h) * 60 + parseInt(m);
                  const diff = Math.abs(slotTime - newEventTime);
                  if (diff < minDiff) { minDiff = diff; newTimeSlotId = slot.id; }
              });

              if (!newDayKey || !newTimeSlotId) { showToast('Vị trí thả không hợp lệ', 'error'); info.revert(); return; }
              try {
                  const classId = info.event.extendedProps.classId;
                  const classDoc = await db.collection('classes').doc(classId).get();
                  if (!classDoc.exists) throw new Error("Không tìm thấy lớp học!");

                  const classData = classDoc.data();
                  const batch = db.batch();
                  batch.update(db.collection('schedule').doc(scheduleId), { day: newDayKey, time: newTimeSlotId });

                  if (classData.day === info.event.extendedProps.originalDay && classData.time === info.event.extendedProps.originalTime) {
                      batch.update(db.collection('classes').doc(classId), { day: newDayKey, time: newTimeSlotId });
                  } else if (classData.day2 === info.event.extendedProps.originalDay && classData.time2 === info.event.extendedProps.originalTime) {
                      batch.update(db.collection('classes').doc(classId), { day2: newDayKey, time2: newTimeSlotId });
                  } else {
                      throw new Error("Không thể xác định buổi học để cập nhật.");
                  }
                  await batch.commit();
                  showToast('Cập nhật lịch học thành công!', 'success');
              } catch (e) { logError(e, 'Lỗi cập nhật lịch'); info.revert(); }
            },
            eventDidMount: function(info) {
              new bootstrap.Tooltip(info.el, { title: info.event.extendedProps.description, placement: 'top', trigger: 'hover', container: 'body' });
            }
        });
        calendar.render();
    }
    
    // FIX START: Replaced old function with a cleaner, more accurate visibility logic
    function setupUIVisibility(role) {
        const isAdmin = role === 'admin';
        const isTeacher = role === 'teacher';
        const isStudent = role === 'student';

        // Elements for Admin only
        document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('d-none', !isAdmin));
        
        // Elements for Teacher only
        document.querySelectorAll('.teacher-only').forEach(el => el.classList.toggle('d-none', !isTeacher));

        // Elements for Student only
        document.querySelectorAll('.student-only').forEach(el => el.classList.toggle('d-none', !isStudent));

        // Elements hidden FOR students (visible to admin and teacher)
        document.querySelectorAll('.hide-from-student').forEach(el => el.classList.toggle('d-none', isStudent));
    }
    // FIX END

    function updateTeacherDropdowns(){
      const options = teachers.map(t => `<option value="${t.id}">${t.name} (${getSubjectName(t.subject)})</option>`).join('');
      const defaultOption = `<option value="" selected disabled>-- Chọn giáo viên --</option>`;
      document.getElementById('classTeacher').innerHTML = defaultOption + options;
      document.getElementById('editClassTeacher').innerHTML = defaultOption + options;
    }
    
    function updateTeacherFilterDropdown() {
        const select = document.getElementById('teacher-filter-select');
        if (!select) return;
        const selectedValue = select.value;
        const options = teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        select.innerHTML = '<option value="all">Tất cả giáo viên</option>' + options;
        select.value = selectedValue;
    }

    function updateClassDropdowns(){
      const options = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      document.getElementById('studentClass').innerHTML = options;
      document.getElementById('editStudentClass').innerHTML = options;
    }

    function populateEditClassModal(classId) {
        const c = classes.find(x => x.id === classId);
        if(!c) return showToast('Không tìm thấy lớp', 'error');
        document.getElementById('editClassId').value = c.id;
        document.getElementById('editClassName').value = c.name || '';
        document.getElementById('editClassSubject').value = c.subject || '';
        document.getElementById('editClassTeacher').value = c.teacherId || '';
        document.getElementById('editClassRoom').value = c.room || '';
        document.getElementById('editClassDay').value = c.day ? (DAY_MAP[c.day] ?? 1) : 1;
        document.getElementById('editClassTime').value = c.time || '';
        document.getElementById('editClassRoom2').value = c.room2 || '';
        document.getElementById('editClassDay2').value = c.day2 ? (DAY_MAP[c.day2] ?? '') : '';
        document.getElementById('editClassTime2').value = c.time2 || '';
        new bootstrap.Modal(document.getElementById('editClassModal')).show();
    }

    function populateEditTeacherModal(id) {
        const t = teachers.find(x=>x.id===id);
        if(!t) return showToast('Không tìm thấy giáo viên', 'error');
        document.getElementById('editTeacherId').value = t.id;
        document.getElementById('editTeacherName').value = t.name || '';
        document.getElementById('editTeacherEmail').value = t.email || '';
        document.getElementById('editTeacherPhone').value = t.phone || '';
        document.getElementById('editTeacherSubject').value = t.subject || '';
        new bootstrap.Modal(document.getElementById('editTeacherModal')).show();
    }

    function populateEditStudentModal(id) {
        const s = students.find(x=>x.id===id);
        if(!s) return showToast('Không tìm thấy học sinh', 'error');
        document.getElementById('editStudentId').value = s.id;
        document.getElementById('editStudentName').value = s.name || '';
        document.getElementById('editStudentEmail').value = s.email || '';
        document.getElementById('editStudentPhone').value = s.phone || '';
        Array.from(document.getElementById('editStudentClass').options).forEach(opt => {
          opt.selected = (s.classes || []).includes(opt.value);
        });
        new bootstrap.Modal(document.getElementById('editStudentModal')).show();
    }
    
    // ------------------------------------
    // --- 5. CRUD OPERATIONS (for Admin) ---
    // ------------------------------------
    async function handleFormSubmit(form, button, actionCallback) {
        form.classList.add('was-validated');
        if (!form.checkValidity()) return;
        setButtonLoadingState(button, true);
        try {
            await actionCallback();
        } catch (e) {
            logError(e, 'Thao tác thất bại');
        } finally {
            setButtonLoadingState(button, false);
            form.classList.remove('was-validated');
        }
    }

    async function addTeacher() {
      const email = document.getElementById('teacherEmail').value.trim();
      const name = document.getElementById('teacherName').value.trim();
      const phone = document.getElementById('teacherPhone').value.trim();
      const subject = document.getElementById('teacherSubject').value;
      const password = Math.random().toString(36).slice(-8);
      // NOTE: This creates the user in Auth, but for a real app, you'd use Cloud Functions to create the user doc.
      // For this example, we'll assume an admin is doing this and has permissions.
      // We can't create another user while logged in with email/password auth easily on the client.
      // This part requires a backend (Cloud Function) to work securely and reliably.
      // For demonstration, we will skip the `createUserWithEmailAndPassword` part and just add to Firestore.
      // **In a real application, you MUST create the Auth user first.**
      await db.collection('users').add({ name, email, phone, role: 'teacher', subject, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      showToast(`Tạo GV thành công. Yêu cầu GV đặt lại mật khẩu.`, 'success');
      bootstrap.Modal.getInstance(document.getElementById('addTeacherModal')).hide();
    }

    async function addStudent() {
      const email = document.getElementById('studentEmail').value.trim();
      const name = document.getElementById('studentName').value.trim();
      const phone = document.getElementById('studentPhone').value.trim();
      const classIds = Array.from(document.getElementById('studentClass').selectedOptions).map(o=>o.value);
      // See note in addTeacher. The same applies here.
      const studentRef = await db.collection('users').add({ name, email, phone, role: 'student', classes: classIds, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      const uid = studentRef.id;
      
      const batch = db.batch();
      classIds.forEach(cid => {
        batch.update(db.collection('classes').doc(cid), { students: firebase.firestore.FieldValue.arrayUnion(uid) });
      });
      await batch.commit();
      showToast(`Tạo HS thành công. Yêu cầu HS đặt lại mật khẩu.`, 'success');
      bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
    }

    async function addClass() {
      const name = document.getElementById('className').value.trim();
      const subject = document.getElementById('classSubject').value;
      const teacherId = document.getElementById('classTeacher').value;
      const room = document.getElementById('classRoom').value.trim();
      const dayKey = REVERSE_DAY_MAP[document.getElementById('classDay').value];
      const time = document.getElementById('classTime').value;
      const room2 = document.getElementById('classRoom2').value.trim();
      const dayKey2 = REVERSE_DAY_MAP[document.getElementById('classDay2').value];
      const time2 = document.getElementById('classTime2').value;

      const classData = { name, subject, teacherId, room: room || null, day: dayKey, time, students: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      if (dayKey2 && time2) {
          classData.day2 = dayKey2; classData.time2 = time2; classData.room2 = room2 || null;
      }
      const classRef = await db.collection('classes').add(classData);
      const batch = db.batch();
      batch.set(db.collection('schedule').doc(), { classId: classRef.id, day: dayKey, time, room: room || null, teacherId });
      if (dayKey2 && time2) {
          batch.set(db.collection('schedule').doc(), { classId: classRef.id, day: dayKey2, time: time2, room: room2 || null, teacherId });
      }
      await batch.commit();
      showToast('Đã tạo lớp và lịch thành công!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('addClassModal')).hide();
    }
    
    // ------------------------------------
    // --- 6. EVENT LISTENERS & INIT ---
    // ------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        deleteConfirmModalInstance = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

        // --- Page Navigation ---
        document.getElementById('sidebar').addEventListener('click', (e) => {
            const link = e.target.closest('.sidebar-nav-item');
            if (!link) return;
            e.preventDefault();
            const targetId = link.dataset.target;
            document.querySelectorAll('.sidebar-nav-item').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            document.querySelectorAll('.page-section').forEach(page => page.classList.toggle('active', page.id === targetId));
        });

        // --- Search functionality ---
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('keyup', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#classesTable tbody tr, #teachersTable tbody tr, #studentsTable tbody tr').forEach(row => {
                if (row.classList.contains('no-data-row')) return;
                const content = (row.dataset.searchContent || '').toLowerCase();
                row.style.display = content.includes(searchTerm) ? '' : 'none';
            });
        });
        document.getElementById('clearSearchBtn').addEventListener('click', () => {
          searchInput.value = '';
          searchInput.dispatchEvent(new Event('keyup'));
        });
        
        // --- Form Submissions (Admin only) ---
        document.getElementById('addTeacherForm').addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(e.target, e.submitter, addTeacher); });
        document.getElementById('addStudentForm').addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(e.target, e.submitter, addStudent); });
        document.getElementById('addClassForm').addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(e.target, e.submitter, addClass); });
        
        document.getElementById('editTeacherForm').addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(e.target, e.submitter, async () => {
          const id = document.getElementById('editTeacherId').value;
          const data = { name: document.getElementById('editTeacherName').value.trim(), email: document.getElementById('editTeacherEmail').value.trim(), phone: document.getElementById('editTeacherPhone').value.trim(), subject: document.getElementById('editTeacherSubject').value };
          await db.collection('users').doc(id).update(data);
          showToast('Cập nhật giáo viên thành công', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editTeacherModal')).hide();
        }); });

        document.getElementById('editStudentForm').addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(e.target, e.submitter, async () => {
          const id = document.getElementById('editStudentId').value;
          const data = { name: document.getElementById('editStudentName').value.trim(), email: document.getElementById('editStudentEmail').value.trim(), phone: document.getElementById('editStudentPhone').value.trim(), classes: Array.from(document.getElementById('editStudentClass').selectedOptions).map(o=>o.value) };
          const prev = (students.find(s=>s.id===id) || { classes: [] }).classes || [];
          const toRemove = prev.filter(x=> !data.classes.includes(x));
          const toAdd = data.classes.filter(x=> !prev.includes(x));
          const batch = db.batch();
          batch.update(db.collection('users').doc(id), data);
          toRemove.forEach(cid => batch.update(db.collection('classes').doc(cid), { students: firebase.firestore.FieldValue.arrayRemove(id) }));
          toAdd.forEach(cid => batch.update(db.collection('classes').doc(cid), { students: firebase.firestore.FieldValue.arrayUnion(id) }));
          await batch.commit();
          showToast('Cập nhật học sinh thành công', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
        }); });

        document.getElementById('editClassForm').addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(e.target, e.submitter, async () => {
          const id = document.getElementById('editClassId').value;
          const updateData = { 
            name: document.getElementById('editClassName').value.trim(), subject: document.getElementById('editClassSubject').value,
            teacherId: document.getElementById('editClassTeacher').value, room: document.getElementById('editClassRoom').value.trim() || null,
            day: REVERSE_DAY_MAP[document.getElementById('editClassDay').value], time: document.getElementById('editClassTime').value,
            day2: REVERSE_DAY_MAP[document.getElementById('editClassDay2').value] || null, time2: document.getElementById('editClassTime2').value || null,
            room2: document.getElementById('editClassRoom2').value.trim() || null
          };
          if (!updateData.day2 || !updateData.time2) {
              updateData.day2 = firebase.firestore.FieldValue.delete(); updateData.time2 = firebase.firestore.FieldValue.delete(); updateData.room2 = firebase.firestore.FieldValue.delete();
          }
          const batch = db.batch();
          batch.update(db.collection('classes').doc(id), updateData);
          (await db.collection('schedule').where('classId', '==', id).get()).forEach(doc => batch.delete(doc.ref));
          batch.set(db.collection('schedule').doc(), { classId: id, day: updateData.day, time: updateData.time, room: updateData.room, teacherId: updateData.teacherId });
          if (updateData.day2 && updateData.time2) {
              batch.set(db.collection('schedule').doc(), { classId: id, day: updateData.day2, time: updateData.time2, room: updateData.room2, teacherId: updateData.teacherId });
          }
          await batch.commit();
          showToast('Cập nhật lớp thành công!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editClassModal')).hide();
        }); });
        
        // --- Table Actions (Edit/Delete for Admin) ---
        document.getElementById('main-content').addEventListener('click', async (e) => {
            if (currentUserProfile?.role !== 'admin') return; // Only admin can perform actions
            const editClassBtn = e.target.closest('.edit-class'); if(editClassBtn) { populateEditClassModal(editClassBtn.dataset.id); return; }
            const editTeacherBtn = e.target.closest('.edit-teacher'); if(editTeacherBtn) { populateEditTeacherModal(editTeacherBtn.dataset.id); return; }
            const editStudentBtn = e.target.closest('.edit-student'); if(editStudentBtn) { populateEditStudentModal(editStudentBtn.dataset.id); return; }
            
            const deleteClassBtn = e.target.closest('.delete-class'); if(deleteClassBtn) {
              showDeleteConfirmModal('Xóa lớp học', `Bạn có chắc muốn xóa lớp "<strong>${deleteClassBtn.dataset.name}</strong>"? Lịch học liên quan cũng sẽ bị xóa.`, async () => {
                try {
                  const id = deleteClassBtn.dataset.id;
                  const snaps = await db.collection('schedule').where('classId','==',id).get();
                  const batch = db.batch();
                  snaps.forEach(d => batch.delete(d.ref));
                  batch.delete(db.collection('classes').doc(id));
                  await batch.commit();
                  showToast('Đã xóa lớp và lịch liên quan', 'success');
                } catch(err){ logError(err, 'Lỗi xóa lớp'); }
              });
              return;
            }
            const deleteTeacherBtn = e.target.closest('.delete-teacher'); if(deleteTeacherBtn) {
              showDeleteConfirmModal('Xóa giáo viên', `Bạn có chắc muốn xóa giáo viên "<strong>${deleteTeacherBtn.dataset.name}</strong>"? Lớp học của giáo viên này sẽ không bị xóa.`, async () => {
                try {
                  const id = deleteTeacherBtn.dataset.id;
                  const clsSnap = await db.collection('classes').where('teacherId','==',id).get();
                  const batch = db.batch();
                  clsSnap.forEach(d => batch.update(d.ref, { teacherId: null }));
                  batch.delete(db.collection('users').doc(id));
                  await batch.commit();
                  showToast('Đã xóa giáo viên', 'success');
                } catch(err){ logError(err, 'Lỗi xóa giáo viên'); }
              });
              return;
            }
            const deleteStudentBtn = e.target.closest('.delete-student'); if(deleteStudentBtn) {
              showDeleteConfirmModal('Xóa học sinh', `Bạn có chắc muốn xóa học sinh "<strong>${deleteStudentBtn.dataset.name}</strong>"? Học sinh sẽ được xóa khỏi các lớp đã đăng ký.`, async () => {
                try {
                  const id = deleteStudentBtn.dataset.id;
                  const clsSnap = await db.collection('classes').where('students','array-contains',id).get();
                  const batch = db.batch();
                  clsSnap.forEach(d => batch.update(d.ref, { students: firebase.firestore.FieldValue.arrayRemove(id) }));
                  batch.delete(db.collection('users').doc(id));
                  await batch.commit();
                  showToast('Đã xóa học sinh', 'success');
                } catch(err){ logError(err, 'Lỗi xóa học sinh'); }
              });
            }
        });
        
        // --- Other listeners ---
        document.getElementById('sidebar-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('toggled'));
        
        document.getElementById('calendar-view-buttons').addEventListener('click', e => {
            const button = e.target.closest('button');
            if(!button || button.classList.contains('active')) return;
            calendar.changeView(button.dataset.view);
            document.querySelectorAll('#calendar-view-buttons button').forEach(b => b.classList.remove('active'));
            button.classList.add('active');
        });

        document.getElementById('teacher-filter-select').addEventListener('change', () => {
            if (calendar) calendar.refetchEvents();
        });

        document.querySelectorAll('.modal').forEach(modalEl => {
          modalEl.addEventListener('hidden.bs.modal', () => {
            const form = modalEl.querySelector('form');
            if(form) {
              form.reset();
              form.classList.remove('was-validated');
            }
          });
          modalEl.addEventListener('shown.bs.modal', () => {
            modalEl.querySelector('input, select')?.focus();
          });
        });
        
        // --- Authentication & App Initialization ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            loginError.classList.add('d-none');
            setButtonLoadingState(loginBtn, true);

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                loginError.textContent = 'Email hoặc mật khẩu không đúng.';
                loginError.classList.remove('d-none');
            } finally {
                setButtonLoadingState(loginBtn, false);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut();
        });

        auth.onAuthStateChanged(async user => {
            const loadingContainer = document.getElementById('loading-container');
            const loginContainer = document.getElementById('login-container');
            const mainWrapper = document.getElementById('wrapper');

            if(user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists || !userDoc.data().role) {
                        throw new Error('Không tìm thấy thông tin người dùng hoặc vai trò không được thiết lập.');
                    }
                    currentUserProfile = { uid: user.uid, ...userDoc.data() };
                    
                    document.getElementById('userDisplayName').textContent = currentUserProfile.name || currentUserProfile.email;
                    
                    // Show main app
                    mainWrapper.classList.remove('d-none');
                    loginContainer.classList.add('d-none');
                    loadingContainer.classList.add('d-none');
                    
                    setupUIVisibility(currentUserProfile.role);
                    initializeCalendar();
                    loadAllData();

                    const timeOptions = TIME_SLOTS.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    document.getElementById('classTime').innerHTML = timeOptions;
                    document.getElementById('editClassTime').innerHTML = timeOptions;
                    document.getElementById('classTime2').innerHTML = `<option value="">-- Chọn --</option>${timeOptions}`;
                    document.getElementById('editClassTime2').innerHTML = `<option value="">-- Chọn --</option>${timeOptions}`;

                } catch (e) {
                    logError(e, 'Lỗi xác thực người dùng');
                    auth.signOut(); // Force sign out if profile is invalid
                }

            } else {
                currentUserProfile = null;
                detachAllListeners(); // Clean up listeners on logout
                // Show login screen
                mainWrapper.classList.add('d-none');
                loadingContainer.classList.add('d-none');
                loginContainer.classList.remove('d-none');
            }
        });
    });
  </script>
</body>
</html>