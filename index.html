<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quản lý Trung tâm - Thời khóa biểu (Có sửa)</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{ --primary:#4e73df; --muted:#6c757d; }
    body{ background:#f8f9fc; font-family: "Segoe UI", Tahoma, Arial, sans-serif; padding:20px; }
    .card { box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    .availability-slot { cursor:pointer; display:inline-block; margin:3px; padding:6px 8px; border-radius:6px; border:1px dashed #ccc; }
    .availability-slot.selected { background:#e9f5ff; border-color:var(--primary); }
    .schedule-cell { min-width:180px; vertical-align:top; }
    .schedule-class { margin-bottom:6px; padding:6px; border-radius:6px; background:#fff; border:1px solid #eee; }
    .time-slot { width:140px; font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <h3 class="mb-3">Quản lý Trung tâm - Thời khóa biểu</h3>

    <div class="row g-3">
      <div class="col-md-8">
        <div class="card mb-3 p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Danh sách lớp</h5>
            <div>
              <button class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#addClassModal">Thêm lớp</button>
              <button class="btn btn-sm btn-primary" id="generateScheduleBtn">Xếp lịch cho lớp</button>
            </div>
          </div>
          <div style="overflow:auto;">
            <table class="table table-striped" id="classesTable">
              <thead><tr><th>Tên lớp</th><th>Môn</th><th>Giáo viên</th><th>HS</th><th>Khung giờ</th><th>Phòng</th><th>Hành động</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h5>Thời khóa biểu (Tuần)</h5>
          <div style="overflow:auto;">
            <table class="table table-bordered align-middle">
              <thead>
                <tr>
                  <th>Khung giờ</th>
                  <th>Thứ 2</th><th>Thứ 3</th><th>Thứ 4</th><th>Thứ 5</th><th>Thứ 6</th><th>Thứ 7</th><th>Chủ nhật</th>
                </tr>
              </thead>
              <tbody id="scheduleTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Giáo viên</h5>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addTeacherModal">Thêm GV</button>
          </div>
          <div style="max-height:220px; overflow:auto;">
            <table class="table table-sm" id="teachersTable">
              <thead><tr><th>Tên</th><th>Email</th><th>Hành động</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Học sinh</h5>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addStudentModal">Thêm HS</button>
          </div>
          <div style="max-height:220px; overflow:auto;">
            <table class="table table-sm" id="studentsTable">
              <thead><tr><th>Tên</th><th>Email</th><th>Hành động</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

    <!-- Add/Edit Modals -->
    <!-- Add Teacher -->
    <div class="modal fade" id="addTeacherModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Thêm Giáo viên</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-2"><label class="form-label">Tên</label><input id="teacherName" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Email</label><input id="teacherEmail" class="form-control" type="email"></div>
            <div class="mb-2"><label class="form-label">SĐT</label><input id="teacherPhone" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Môn</label>
              <select id="teacherSubject" class="form-select">
                <option value="math">Toán</option>
                <option value="physics">Vật lý</option>
                <option value="chemistry">Hóa</option>
                <option value="literature">Ngữ văn</option>
                <option value="english">Tiếng Anh</option>
                <option value="history">Lịch sử</option>
                <option value="geography">Địa lý</option>
              </select>
            </div>
          </div>
          <div class="modal-footer"><button id="saveTeacherBtn" class="btn btn-primary">Lưu</button></div>
        </div>
      </div>
    </div>

    <!-- Edit Teacher -->
    <div class="modal fade" id="editTeacherModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Sửa Giáo viên</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="editTeacherId">
            <div class="mb-2"><label class="form-label">Tên</label><input id="editTeacherName" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Email (lưu vào Firestore)</label><input id="editTeacherEmail" class="form-control" type="email"></div>
            <div class="mb-2"><label class="form-label">SĐT</label><input id="editTeacherPhone" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Môn</label>
              <select id="editTeacherSubject" class="form-select">
                <option value="math">Toán</option>
                <option value="physics">Vật lý</option>
                <option value="chemistry">Hóa</option>
                <option value="literature">Ngữ văn</option>
                <option value="english">Tiếng Anh</option>
                <option value="history">Lịch sử</option>
                <option value="geography">Địa lý</option>
              </select>
            </div>
            <div class="text-muted small">Lưu ý: thay đổi email trong Authentication yêu cầu xử lý riêng (không tự động sửa Auth ở đây).</div>
          </div>
          <div class="modal-footer"><button id="updateTeacherBtn" class="btn btn-primary">Cập nhật</button></div>
        </div>
      </div>
    </div>

    <!-- Add Student -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Thêm Học sinh</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-2"><label class="form-label">Tên</label><input id="studentName" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Email</label><input id="studentEmail" class="form-control" type="email"></div>
            <div class="mb-2"><label class="form-label">SĐT</label><input id="studentPhone" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Chọn lớp (Ctrl/Shift chọn nhiều)</label>
              <select id="studentClass" class="form-select" multiple></select>
            </div>
          </div>
          <div class="modal-footer"><button id="saveStudentBtn" class="btn btn-primary">Lưu</button></div>
        </div>
      </div>
    </div>

    <!-- Edit Student -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Sửa Học sinh</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="editStudentId">
            <div class="mb-2"><label class="form-label">Tên</label><input id="editStudentName" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Email (lưu vào Firestore)</label><input id="editStudentEmail" class="form-control" type="email"></div>
            <div class="mb-2"><label class="form-label">SĐT</label><input id="editStudentPhone" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Chọn lớp (Ctrl/Shift chọn nhiều)</label>
              <select id="editStudentClass" class="form-select" multiple></select>
            </div>
            <div class="text-muted small">Lưu ý: để thay đổi email trong Authentication cần thao tác riêng.</div>
          </div>
          <div class="modal-footer"><button id="updateStudentBtn" class="btn btn-primary">Cập nhật</button></div>
        </div>
      </div>
    </div>

    <!-- Add Class -->
    <div class="modal fade" id="addClassModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Thêm Lớp</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="mb-2"><label class="form-label">Tên lớp</label><input id="className" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Môn</label>
              <select id="classSubject" class="form-select">
                <option value="math">Toán</option>
                <option value="physics">Vật lý</option>
                <option value="chemistry">Hóa</option>
                <option value="literature">Ngữ văn</option>
                <option value="english">Tiếng Anh</option>
                <option value="history">Lịch sử</option>
                <option value="geography">Địa lý</option>
              </select>
            </div>
            <div class="mb-2"><label class="form-label">Giáo viên</label>
              <select id="classTeacher" class="form-select"></select>
            </div>
            <div class="mb-2 row">
              <div class="col-6"><label class="form-label">Phòng (tuỳ chọn)</label><input id="classRoom" class="form-control" placeholder="101..."></div>
              <div class="col-6"><label class="form-label">Ngày</label>
                <select id="classDay" class="form-select">
                  <option value="monday">Thứ 2</option>
                  <option value="tuesday">Thứ 3</option>
                  <option value="wednesday">Thứ 4</option>
                  <option value="thursday">Thứ 5</option>
                  <option value="friday">Thứ 6</option>
                  <option value="saturday">Thứ 7</option>
                  <option value="sunday">Chủ nhật</option>
                </select>
              </div>
            </div>
            <div class="mb-2"><label class="form-label">Khung giờ</label>
              <select id="classTime" class="form-select"></select>
            </div>
          </div>
          <div class="modal-footer"><button id="saveClassBtn" class="btn btn-primary">Lưu lớp</button></div>
        </div>
      </div>
    </div>

    <!-- Edit Class -->
    <div class="modal fade" id="editClassModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Sửa Lớp</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="editClassId">
            <div class="mb-2"><label class="form-label">Tên lớp</label><input id="editClassName" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Môn</label>
              <select id="editClassSubject" class="form-select">
                <option value="math">Toán</option>
                <option value="physics">Vật lý</option>
                <option value="chemistry">Hóa</option>
                <option value="literature">Ngữ văn</option>
                <option value="english">Tiếng Anh</option>
                <option value="history">Lịch sử</option>
                <option value="geography">Địa lý</option>
              </select>
            </div>
            <div class="mb-2"><label class="form-label">Giáo viên</label>
              <select id="editClassTeacher" class="form-select"></select>
            </div>
            <div class="mb-2 row">
              <div class="col-6"><label class="form-label">Phòng</label><input id="editClassRoom" class="form-control" placeholder="101..."></div>
              <div class="col-6"><label class="form-label">Ngày</label>
                <select id="editClassDay" class="form-select">
                  <option value="monday">Thứ 2</option>
                  <option value="tuesday">Thứ 3</option>
                  <option value="wednesday">Thứ 4</option>
                  <option value="thursday">Thứ 5</option>
                  <option value="friday">Thứ 6</option>
                  <option value="saturday">Thứ 7</option>
                  <option value="sunday">Chủ nhật</option>
                </select>
              </div>
            </div>
            <div class="mb-2"><label class="form-label">Khung giờ</label>
              <select id="editClassTime" class="form-select"></select>
            </div>
            <div class="text-muted small">Thao tác này chỉ cập nhật document lớp; schedule liên quan có thể cần điều chỉnh thủ công hoặc chạy lại chức năng xếp lịch.</div>
          </div>
          <div class="modal-footer"><button id="updateClassBtn" class="btn btn-primary">Cập nhật lớp</button></div>
        </div>
      </div>
    </div>

    <!-- Schedule picker -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
          <h5>Chọn lớp để xếp lịch</h5>
          <select id="classToSchedule" class="form-select mb-3"></select>
          <div class="d-flex justify-content-end">
            <button class="btn btn-secondary me-2" data-bs-dismiss="modal">Huỷ</button>
            <button id="doGenerateBtn" class="btn btn-primary">Xếp lịch</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAPcaScN-HrCcxiUz_J1QrrREF9sxCfvD8",
      authDomain: "mathhubvn.firebaseapp.com",
      projectId: "mathhubvn",
      storageBucket: "mathhubvn.firebasestorage.app",
      messagingSenderId: "1001364433767",
      appId: "1:1001364433767:web:ae1547dc7d1524a6319dc2",
      measurementId: "G-2YNQZ48JVK"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ---------- State ----------
    let currentUser = null;
    let classes = [], teachers = [], students = [], schedule = [];

    const ROOMS = ['101','102','103','104','105','106'];
    const TIME_SLOTS = [
      { id: 'slot1', name: '07:00-09:00', start: '07:00', end: '09:00' },
      { id: 'slot2', name: '09:15-11:15', start: '09:15', end: '11:15' },
      { id: 'slot3', name: '14:00-16:00', start: '14:00', end: '16:00' },
      { id: 'slot4', name: '16:30-18:30', start: '16:30', end: '18:30' },
      { id: 'slot5', name: '19:00-21:00', start: '19:00', end: '21:00' }
    ];

    function logError(e){ console.error(e); alert('Lỗi: ' + (e.message || e)); }

    // ---------- Load realtime data ----------
    function loadData(){
      db.collection('classes').onSnapshot(snap => {
        classes = [];
        snap.forEach(d=> classes.push({ id:d.id, ...d.data() }));
        renderClasses(); updateClassDropdowns();
      }, logError);

      db.collection('users').where('role','==','teacher').onSnapshot(snap=>{
        teachers = []; snap.forEach(d=> teachers.push({ id:d.id, ...d.data() }));
        renderTeachers(); updateTeacherDropdowns();
      }, logError);

      db.collection('users').where('role','==','student').onSnapshot(snap=>{
        students = []; snap.forEach(d=> students.push({ id:d.id, ...d.data() }));
        renderStudents(); updateStudentClassDropdowns();
      }, logError);

      db.collection('schedule').onSnapshot(snap=>{
        schedule = []; snap.forEach(d=> schedule.push({ id:d.id, ...d.data() }));
        renderSchedule();
      }, logError);
    }

    // ---------- Render functions (include Edit buttons) ----------
    function renderClasses(){
      const tbody = document.querySelector('#classesTable tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      classes.forEach(c=>{
        const tr = document.createElement('tr');
        const teacherName = getTeacherName(c.teacherId);
        const studentCount = (c.students||[]).length;
        tr.innerHTML = `
          <td>${c.name}</td>
          <td>${getSubjectName(c.subject)}</td>
          <td>${teacherName}</td>
          <td>${studentCount} hs</td>
          <td>${getDayName(c.day)||''} ${getTimeSlotName(c.time)||''}</td>
          <td>${c.room||'Chưa'}</td>
          <td>
            <button class="btn btn-sm btn-primary edit-class" data-id="${c.id}">Sửa</button>
            <button class="btn btn-sm btn-danger delete-class" data-id="${c.id}">Xóa</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    function renderTeachers(){
      const tbody = document.querySelector('#teachersTable tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      teachers.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.name}</td><td>${t.email||''}</td><td>
          <button class="btn btn-sm btn-primary edit-teacher" data-id="${t.id}">Sửa</button>
          <button class="btn btn-sm btn-danger delete-teacher" data-id="${t.id}">Xóa</button>
        </td>`;
        tbody.appendChild(tr);
      });
    }
    function renderStudents(){
      const tbody = document.querySelector('#studentsTable tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      students.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.name}</td><td>${s.email||''}</td><td>
          <button class="btn btn-sm btn-primary edit-student" data-id="${s.id}">Sửa</button>
          <button class="btn btn-sm btn-danger delete-student" data-id="${s.id}">Xóa</button>
        </td>`;
        tbody.appendChild(tr);
      });
    }

    function renderSchedule(){
      const tbody = document.getElementById('scheduleTableBody');
      if(!tbody) return;
      tbody.innerHTML = '';
      const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
      TIME_SLOTS.forEach(slot=>{
        const tr = document.createElement('tr');
        let html = `<td class="time-slot">${slot.name}</td>`;
        days.forEach(day=>{
          html += `<td class="schedule-cell">`;
          const entries = schedule.filter(s => s.day===day && s.time===slot.id);
          entries.forEach(en=>{
            const cls = classes.find(c=>c.id===en.classId);
            const teacher = getTeacherName(en.teacherId|| (cls?cls.teacherId:null));
            html += `<div class="schedule-class">
              <div class="fw-bold">${cls?cls.name:'(Lớp đã xóa)'}</div>
              <div class="small">${getSubjectName(cls?cls.subject:null)} - ${teacher}</div>
              <div class="small">Phòng: ${en.room|| (cls?cls.room:'Chưa')}</div>
            </div>`;
          });
          html += `</td>`;
        });
        tr.innerHTML = html;
        tbody.appendChild(tr);
      });
    }

    // ---------- Helpers ----------
    function getSubjectName(id){ const map = {math:'Toán',physics:'Vật lý',chemistry:'Hóa',literature:'Ngữ văn',english:'Tiếng Anh',history:'Lịch sử',geography:'Địa lý'}; return map[id]||''; }
    function getTeacherName(id){ if(!id) return 'Chưa'; const t = teachers.find(x=>x.id===id); return t? t.name : 'Chưa'; }
    function getDayName(day){ const m={monday:'Thứ 2',tuesday:'Thứ 3',wednesday:'Thứ 4',thursday:'Thứ 5',friday:'Thứ 6',saturday:'Thứ 7',sunday:'Chủ nhật'}; return m[day]||''; }
    function getTimeSlotName(id){ const s = TIME_SLOTS.find(x=>x.id===id); return s? s.name : ''; }

    // ---------- Dropdown updates ----------
    function updateTeacherDropdowns(){
      const sel = document.getElementById('classTeacher');
      const selEdit = document.getElementById('editClassTeacher');
      if(sel){ sel.innerHTML = '<option value="">-- Chọn giáo viên --</option>'; teachers.forEach(t=> { const o = document.createElement('option'); o.value = t.id; o.textContent = t.name + ' (' + (t.subject?getSubjectName(t.subject):'') + ')'; sel.appendChild(o); }); }
      if(selEdit){ selEdit.innerHTML = '<option value="">-- Chọn giáo viên --</option>'; teachers.forEach(t=> { const o = document.createElement('option'); o.value = t.id; o.textContent = t.name + ' (' + (t.subject?getSubjectName(t.subject):'') + ')'; selEdit.appendChild(o); }); }
    }
    function updateClassDropdowns(){
      const select = document.getElementById('studentClass');
      if(select){ select.innerHTML=''; classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; select.appendChild(o); }); }
      const scheduleSel = document.getElementById('classToSchedule');
      if(scheduleSel){ scheduleSel.innerHTML = '<option value="">-- Chọn lớp --</option>'; classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; scheduleSel.appendChild(o); }); }
      // Also update edit-student class select
      const editSelect = document.getElementById('editStudentClass');
      if(editSelect){ editSelect.innerHTML=''; classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; editSelect.appendChild(o); }); }
      const addStudentSelect = document.getElementById('studentClass');
      if(addStudentSelect){ addStudentSelect.innerHTML=''; classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; addStudentSelect.appendChild(o); }); }
    }
    function updateStudentClassDropdowns(){ updateClassDropdowns(); }

    // ---------- CRUD operations ----------
    async function addTeacher(){
      const name = document.getElementById('teacherName').value.trim();
      const email = document.getElementById('teacherEmail').value.trim();
      const phone = document.getElementById('teacherPhone').value.trim();
      const subject = document.getElementById('teacherSubject').value;
      if(!name||!email||!subject) return alert('Vui lòng điền đầy đủ');
      try{
        const password = Math.random().toString(36).slice(-8);
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const uid = userCredential.user.uid;
        await userCredential.user.updateProfile({ displayName: name });
        await db.collection('users').doc(uid).set({ name, email, phone, role: 'teacher', subject, availability: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        alert('Tạo giáo viên thành công. Mật khẩu tạm thời: ' + password);
        var modal = bootstrap.Modal.getInstance(document.getElementById('addTeacherModal')); modal.hide();
      } catch(e){ logError(e); }
    }

    async function addStudent(){
      const name = document.getElementById('studentName').value.trim();
      const email = document.getElementById('studentEmail').value.trim();
      const phone = document.getElementById('studentPhone').value.trim();
      const classIds = Array.from(document.getElementById('studentClass').selectedOptions).map(o=>o.value);
      if(!name||!email) return alert('Vui lòng điền tên và email');
      try{
        const password = Math.random().toString(36).slice(-8);
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const uid = userCredential.user.uid;
        await userCredential.user.updateProfile({ displayName: name });
        await db.collection('users').doc(uid).set({ name, email, phone, role: 'student', classes: classIds, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        // Update classes: push student ids
        const batch = db.batch();
        classIds.forEach(cid => {
          const clsRef = db.collection('classes').doc(cid);
          batch.update(clsRef, { students: firebase.firestore.FieldValue.arrayUnion(uid) });
        });
        await batch.commit();
        alert('Tạo học sinh thành công. Mật khẩu tạm thời: ' + password);
        bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
      } catch(e){ logError(e); }
    }

    async function addClass(){
      const name = document.getElementById('className').value.trim();
      const subject = document.getElementById('classSubject').value;
      const teacherId = document.getElementById('classTeacher').value;
      const room = document.getElementById('classRoom').value.trim();
      const day = document.getElementById('classDay').value;
      const time = document.getElementById('classTime').value;
      if(!name||!subject||!teacherId||!day||!time) return alert('Vui lòng điền đầy đủ thông tin lớp và lịch');
      try{
        const classRef = await db.collection('classes').add({ name, subject, teacherId, room: room||null, day, time, students: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        // Also add an initial schedule entry
        await db.collection('schedule').add({ classId: classRef.id, day, time, room: room||null, teacherId });
        alert('Đã tạo lớp và lịch ban đầu');
        bootstrap.Modal.getInstance(document.getElementById('addClassModal')).hide();
      } catch(e){ logError(e); }
    }

    // ---------- Edit handlers ----------
    // Open edit modals and prefill
    document.addEventListener('click', (e)=>{
      // Edit teacher
      if(e.target.matches('.edit-teacher')){
        const id = e.target.dataset.id;
        const t = teachers.find(x=>x.id===id);
        if(!t) return alert('Không tìm thấy giáo viên');
        document.getElementById('editTeacherId').value = t.id;
        document.getElementById('editTeacherName').value = t.name || '';
        document.getElementById('editTeacherEmail').value = t.email || '';
        document.getElementById('editTeacherPhone').value = t.phone || '';
        document.getElementById('editTeacherSubject').value = t.subject || '';
        new bootstrap.Modal(document.getElementById('editTeacherModal')).show();
      }

      // Edit student
      if(e.target.matches('.edit-student')){
        const id = e.target.dataset.id;
        const s = students.find(x=>x.id===id);
        if(!s) return alert('Không tìm thấy học sinh');
        document.getElementById('editStudentId').value = s.id;
        document.getElementById('editStudentName').value = s.name || '';
        document.getElementById('editStudentEmail').value = s.email || '';
        document.getElementById('editStudentPhone').value = s.phone || '';
        // populate class multi-select and preselect current classes
        const sel = document.getElementById('editStudentClass');
        sel.innerHTML = '';
        classes.forEach(c => {
          const o = document.createElement('option');
          o.value = c.id; o.textContent = c.name;
          if((s.classes||[]).includes(c.id)) o.selected = true;
          sel.appendChild(o);
        });
        new bootstrap.Modal(document.getElementById('editStudentModal')).show();
      }

      // Edit class
      if(e.target.matches('.edit-class')){
        const id = e.target.dataset.id;
        const c = classes.find(x=>x.id===id);
        if(!c) return alert('Không tìm thấy lớp');
        document.getElementById('editClassId').value = c.id;
        document.getElementById('editClassName').value = c.name || '';
        document.getElementById('editClassSubject').value = c.subject || '';
        // teacher dropdown
        const sel = document.getElementById('editClassTeacher');
        sel.innerHTML = '<option value="">-- Chọn giáo viên --</option>';
        teachers.forEach(t=> { const o=document.createElement('option'); o.value=t.id; o.textContent = t.name; sel.appendChild(o); });
        document.getElementById('editClassTeacher').value = c.teacherId || '';
        document.getElementById('editClassRoom').value = c.room || '';
        document.getElementById('editClassDay').value = c.day || 'monday';
        document.getElementById('editClassTime').value = c.time || '';
        new bootstrap.Modal(document.getElementById('editClassModal')).show();
      }
    });

    // Update teacher
    document.getElementById('updateTeacherBtn').addEventListener('click', async ()=>{
      const id = document.getElementById('editTeacherId').value;
      const name = document.getElementById('editTeacherName').value.trim();
      const email = document.getElementById('editTeacherEmail').value.trim();
      const phone = document.getElementById('editTeacherPhone').value.trim();
      const subject = document.getElementById('editTeacherSubject').value;
      if(!id) return alert('Không có id giáo viên');
      try{
        await db.collection('users').doc(id).update({ name, email, phone, subject });
        alert('Cập nhật giáo viên thành công');
        bootstrap.Modal.getInstance(document.getElementById('editTeacherModal')).hide();
      } catch(e){ logError(e); }
    });

    // Update student (handle class arrays)
    document.getElementById('updateStudentBtn').addEventListener('click', async ()=>{
      const id = document.getElementById('editStudentId').value;
      const name = document.getElementById('editStudentName').value.trim();
      const email = document.getElementById('editStudentEmail').value.trim();
      const phone = document.getElementById('editStudentPhone').value.trim();
      const selectedClassIds = Array.from(document.getElementById('editStudentClass').selectedOptions).map(o=>o.value);
      if(!id) return alert('Không có id học sinh');
      try{
        // get current classes from students[] in memory (watchers keep it updated)
        const studentDoc = students.find(s=>s.id===id) || { classes: [] };
        const prev = studentDoc.classes || [];

        // compute removed and added
        const toRemove = prev.filter(x=> !selectedClassIds.includes(x));
        const toAdd = selectedClassIds.filter(x=> !prev.includes(x));

        const batch = db.batch();
        // update student's user doc
        batch.update(db.collection('users').doc(id), { name, email, phone, classes: selectedClassIds });
        // remove from old classes
        toRemove.forEach(cid => batch.update(db.collection('classes').doc(cid), { students: firebase.firestore.FieldValue.arrayRemove(id) }));
        // add to new classes
        toAdd.forEach(cid => batch.update(db.collection('classes').doc(cid), { students: firebase.firestore.FieldValue.arrayUnion(id) }));
        await batch.commit();
        alert('Cập nhật học sinh thành công');
        bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
      } catch(e){ logError(e); }
    });

    // Update class
    document.getElementById('updateClassBtn').addEventListener('click', async ()=>{
      const id = document.getElementById('editClassId').value;
      const name = document.getElementById('editClassName').value.trim();
      const subject = document.getElementById('editClassSubject').value;
      const teacherId = document.getElementById('editClassTeacher').value;
      const room = document.getElementById('editClassRoom').value.trim();
      const day = document.getElementById('editClassDay').value;
      const time = document.getElementById('editClassTime').value;
      if(!id) return alert('Không có id lớp');
      try{
        await db.collection('classes').doc(id).update({ name, subject, teacherId: teacherId || null, room: room || null, day, time });
        alert('Cập nhật lớp thành công');
        bootstrap.Modal.getInstance(document.getElementById('editClassModal')).hide();
      } catch(e){ logError(e); }
    });

    // ---------- Delete handlers ----------
    document.addEventListener('click', async (e)=>{
      if(e.target.matches('.delete-class')){
        const id = e.target.dataset.id;
        if(!confirm('Xác nhận xóa lớp?')) return;
        try{
          const snaps = await db.collection('schedule').where('classId','==',id).get();
          const batch = db.batch();
          snaps.forEach(d => batch.delete(d.ref));
          batch.delete(db.collection('classes').doc(id));
          await batch.commit();
          alert('Đã xóa lớp và lịch liên quan');
        } catch(err){ logError(err); }
      }
      if(e.target.matches('.delete-teacher')){
        const id = e.target.dataset.id;
        if(!confirm('Xóa giáo viên? Các lớp sẽ không có giáo viên cho đến khi gán lại.')) return;
        try{
          const clsSnap = await db.collection('classes').where('teacherId','==',id).get();
          const batch = db.batch();
          clsSnap.forEach(d => batch.update(d.ref, { teacherId: null }));
          batch.delete(db.collection('users').doc(id));
          await batch.commit();
          alert('Đã xóa giáo viên và cập nhật lớp');
        } catch(err){ logError(err); }
      }
      if(e.target.matches('.delete-student')){
        const id = e.target.dataset.id;
        if(!confirm('Xóa học sinh?')) return;
        try{
          const clsSnap = await db.collection('classes').where('students','array-contains',id).get();
          const batch = db.batch();
          clsSnap.forEach(d => batch.update(d.ref, { students: firebase.firestore.FieldValue.arrayRemove(id) }));
          batch.delete(db.collection('users').doc(id));
          await batch.commit();
          alert('Đã xóa học sinh');
        } catch(err){ logError(err); }
      }
    });

    // ---------- Scheduling algorithm (same as before) ----------
    async function generateScheduleForClass(classId){
      const cls = classes.find(c=>c.id===classId);
      if(!cls) return alert('Lớp không tồn tại');
      const existing = schedule.filter(s=>s.classId===classId);
      if(existing.length >= 2) return alert('Lớp đã có tối đa 2 buổi/tuần');
      const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
      for(const day of days){
        for(const slot of TIME_SLOTS){
          const teacherConflict = schedule.some(s=> s.day===day && s.time===slot.id && s.teacherId === cls.teacherId);
          if(teacherConflict) continue;
          const studentIds = cls.students || [];
          let studentConflict = false;
          for(const stId of studentIds){
            if( schedule.some(s=> s.day===day && s.time===slot.id && ( s.studentIds ? s.studentIds.includes(stId) : ( s.classId && classes.find(c=>c.id===s.classId && (c.students||[]).includes(stId) ) ) ) ) ){
              studentConflict = true; break;
            }
          }
          if(studentConflict) continue;
          const studentCount = studentIds.length;
          let roomChoice = null;
          if(studentCount > 25){
            const preferred = ['101','102'];
            for(const r of preferred){
              const occupied = schedule.some(s=> s.day===day && s.time===slot.id && s.room===r);
              if(!occupied){ roomChoice = r; break; }
            }
          }
          if(!roomChoice){
            if(cls.subject === 'english'){
              const occ = schedule.some(s=> s.day===day && s.time===slot.id && s.room === '101');
              if(!occ) roomChoice = '101';
            }
          }
          if(!roomChoice){
            roomChoice = ROOMS.find(r => !schedule.some(s=> s.day===day && s.time===slot.id && s.room===r));
          }
          if(!roomChoice) continue;
          try{
            const payload = { classId: classId, day, time: slot.id, room: roomChoice, teacherId: cls.teacherId };
            await db.collection('schedule').add(payload);
            await db.collection('classes').doc(classId).update({ room: roomChoice });
            alert('Đã xếp lịch cho ' + cls.name + ' — ' + getDayName(day) + ' ' + slot.name + ' phòng ' + roomChoice);
            return;
          } catch(e){ logError(e); return; }
        }
      }
      alert('Không tìm được khung giờ phù hợp (có thể do trùng giáo viên/học sinh/phòng)');
    }

    // Hook up generateScheduleBtn
    document.getElementById('generateScheduleBtn').addEventListener('click', ()=>{
      const modalEl = document.getElementById('scheduleModal');
      const modal = new bootstrap.Modal(modalEl);
      updateClassDropdowns();
      modal.show();
    });
    document.getElementById('doGenerateBtn').addEventListener('click', async ()=>{
      const cid = document.getElementById('classToSchedule').value;
      if(!cid) return alert('Chọn lớp cần xếp lịch');
      await generateScheduleForClass(cid);
      bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
    });

    // ---------- Wire up add/save buttons ----------
    document.getElementById('saveTeacherBtn').addEventListener('click', addTeacher);
    document.getElementById('saveStudentBtn').addEventListener('click', addStudent);
    document.getElementById('saveClassBtn').addEventListener('click', addClass);

    // ---------- Availability UI init ----------
    function initAvailabilityUI(){
      // intentionally left minimal; availability saving exists in earlier version
    }

    // ---------- Init on auth state ----------
    auth.onAuthStateChanged(user=>{
      if(user){
        currentUser = user;
        loadData();
        initAvailabilityUI();
        // prepopulate classTime selects
        const classTime = document.getElementById('classTime');
        const editClassTime = document.getElementById('editClassTime');
        [classTime, editClassTime].forEach(ct=>{
          if(ct){
            ct.innerHTML = '';
            TIME_SLOTS.forEach(s=>{ const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; ct.appendChild(o); });
          }
        });
      } else {
        // still load data to allow admin usage if not enforced by auth rules
        loadData();
        initAvailabilityUI();
        const classTime = document.getElementById('classTime');
        const editClassTime = document.getElementById('editClassTime');
        [classTime, editClassTime].forEach(ct=>{
          if(ct){
            ct.innerHTML = '';
            TIME_SLOTS.forEach(s=>{ const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; ct.appendChild(o); });
          }
        });
      }
    });

    // ---------- Initial DOM wiring ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      // nothing special; data listeners will populate UI
    });
  </script>
</body>
</html>
